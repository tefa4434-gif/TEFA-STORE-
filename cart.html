<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ุณูุฉ ุงูุทูุจุงุช | TEFA STORE</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

  <!-- ุงูููุฏุฑ -->
  <header class="bg-black text-white py-3 shadow">
    <div class="max-w-3xl mx-auto flex items-center justify-between px-4">
      <a href="index.html" class="font-bold text-xl">TEFA STORE</a>

      <!-- ุฃููููุฉ ุงูุณูุฉ ูุน ุงูุนุฏุงุฏ -->
      <a href="cart.html" class="relative flex items-center gap-2">
        <span class="text-sm">ุณูุฉ ุงูุทูุจุงุช</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M3.75 5.25h1.5l2.25 12h10.5l2.25-9H7.5" />
        </svg>
        <span id="cartBadge"
              class="absolute -top-2 -left-2 bg-red-500 text-xs rounded-full w-5 h-5 flex items-center justify-center">
          0
        </span>
      </a>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-6 space-y-6">

    <h1 class="text-2xl font-bold mb-2">ุณูุฉ ุงูุทูุจุงุช</h1>

    <!-- ุชูุจูู ุงูุณูุฉ ูุงุถูุฉ -->
    <div id="emptyMessage"
         class="hidden bg-white rounded-xl shadow p-4 text-center text-gray-600">
      ุงูุณูุฉ ุญุงููุงู ูุงุถูุฉ ๐<br>
      <a href="index.html" class="mt-2 inline-block text-sm text-blue-600 underline">
        ุนูุฏู ูุตูุญุฉ ุงูููุชุฌุงุช ูุงุฎุชุงุฑู ููุฏููุงุชู
      </a>
    </div>

    <!-- ูุงุฆูุฉ ุงูููุชุฌุงุช -->
    <div id="cartItemsContainer" class="space-y-4"></div>

    <!-- ููุฎุต ุงูุฃุณุนุงุฑ -->
    <div id="summaryBox" class="hidden bg-white rounded-xl shadow p-4 space-y-2 text-sm">
      <div class="flex justify-between">
        <span>ุฅุฌูุงูู ุงูููุชุฌุงุช</span>
        <span id="productsTotal">0 ุฌ</span>
      </div>
      <div class="flex justify-between">
        <span>ุงูุฎุตู (ุฅู ูุฌุฏ)</span>
        <span id="discountAmount">0 ุฌ</span>
      </div>
      <div class="flex justify-between">
        <span>ุงูุดุญู</span>
        <span id="shippingAmount">0 ุฌ</span>
      </div>
      <hr class="my-2">
      <div class="flex justify-between font-bold text-lg">
        <span>ุงูุฅุฌูุงูู ุจุนุฏ ุงูุฎุตู</span>
        <span id="grandTotal">0 ุฌ</span>
      </div>
    </div>

    <!-- ููุฑู ุงูุจูุงูุงุช -->
    <section id="orderFormSection"
             class="hidden bg-white rounded-xl shadow p-4 space-y-3">
      <h2 class="font-bold text-lg mb-2">ุฅุชูุงู ุงูุทูุจ</h2>

      <div class="grid grid-cols-1 gap-3">
        <div>
          <label class="block text-sm mb-1">ุงูุงุณู ุงููุงูู</label>
          <input id="name" type="text" class="w-full border rounded-lg px-3 py-2"
                 placeholder="ุงูุชุจู ุงุณูู ุซูุงุซู" />
        </div>

        <div>
          <label class="block text-sm mb-1">ุฑูู ุงูููุจุงูู</label>
          <input id="phone" type="tel" class="w-full border rounded-lg px-3 py-2"
                 placeholder="01XXXXXXXXX" />
        </div>

        <div>
          <label class="block text-sm mb-1">ุฑูู ููุจุงูู ุขุฎุฑ (ุงุฎุชูุงุฑู)</label>
          <input id="phone2" type="tel" class="w-full border rounded-lg px-3 py-2"
                 placeholder="ููุทูุงุฑุฆ ุฃู ุงููุงุชุณุงุจ" />
        </div>

        <div>
          <label class="block text-sm mb-1">ุงููุญุงูุธุฉ</label>
          <select id="governorate" class="w-full border rounded-lg px-3 py-2 bg-white">
            <option value="">ุงุฎุชุงุฑู ุงููุญุงูุธุฉ</option>
            <option>ุงููุงูุฑุฉ</option>
            <option>ุงูุฌูุฒุฉ</option>
            <option>ุงูููููุจูุฉ</option>
            <option>ุงูุงุณููุฏุฑูุฉ</option>
            <option>ุงูุฏููููุฉ</option>
            <option>ุงูุดุฑููุฉ</option>
            <option>ุงูุบุฑุจูุฉ</option>
            <option>ุงููููููุฉ</option>
            <option>ุงูุจุญูุฑุฉ</option>
            <option>ููุฑ ุงูุดูุฎ</option>
            <option>ุงููููู</option>
            <option>ุจูู ุณููู</option>
            <option>ุงููููุง</option>
            <option>ุฃุณููุท</option>
            <option>ุณููุงุฌ</option>
            <option>ููุง</option>
            <option>ุงูุฃูุตุฑ</option>
            <option>ุฃุณูุงู</option>
            <option>ุจูุฑุณุนูุฏ</option>
            <option>ุงูุงุณูุงุนูููุฉ</option>
            <option>ุงูุณููุณ</option>
            <option>ุฏููุงุท</option>
            <option>ูุทุฑูุญ</option>
            <option>ุงูุจุญุฑ ุงูุฃุญูุฑ</option>
            <option>ุงููุงุฏู ุงูุฌุฏูุฏ</option>
            <option>ุดูุงู ุณููุงุก</option>
            <option>ุฌููุจ ุณููุงุก</option>
            <option>ุดุฑู ุงูุดูุฎ</option>
            <option>ุงูุบุฑุฏูุฉ</option>
            <option>ูุฑุณู ูุทุฑูุญ</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">
            ุงูุดุญู: ุงููุงูุฑุฉ ูุงูุฌูุฒุฉ 60 ุฌ โ ุจุงูู ุงููุญุงูุธุงุช 70 ุฌ โ  
            ุดุฑู ุงูุดูุฎ / ุงูุบุฑุฏูุฉ / ูุฑุณู ูุทุฑูุญ / ุดูุงู ุณููุงุก / ุฌููุจ ุณููุงุก / ุงููุงุฏู ุงูุฌุฏูุฏ 120 ุฌ
          </p>
        </div>

        <div>
          <label class="block text-sm mb-1">ุงูุนููุงู ุจุงูุชูุตูู</label>
          <textarea id="address" rows="2"
                    class="w-full border rounded-lg px-3 py-2"
                    placeholder="ุงูุดุงุฑุน / ุฑูู ุงูุจูุช / ุงูุนูุงูุฉ ุงููููุฒุฉ"></textarea>
        </div>

        <div>
          <label class="block text-sm mb-1">ููุงุญุธุงุช ููุทูุจ (ุงุฎุชูุงุฑู)</label>
          <textarea id="notes" rows="2"
                    class="w-full border rounded-lg px-3 py-2"
                    placeholder="ูุซุงู: ููุงุณ ูุงุณุน ุดููุฉุ ููุถู ุงุชุตุงู ูุจู ุงูุดุญู ..."></textarea>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">ุงููุฒู (ุงุฎุชูุงุฑู)</label>
            <input id="weight" type="text" class="w-full border rounded-lg px-3 py-2"
                   placeholder="ูุซุงู: 75 ู" />
          </div>
          <div>
            <label class="block text-sm mb-1">ุงูุทูู (ุงุฎุชูุงุฑู)</label>
            <input id="height" type="text" class="w-full border rounded-lg px-3 py-2"
                   placeholder="ูุซุงู: 165 ุณู" />
          </div>
        </div>

        <div>
          <label class="block text-sm mb-1">ููุฏ ุงูุฎุตู</label>
          <input id="coupon" type="text" class="w-full border rounded-lg px-3 py-2"
                 placeholder="ุงูุชุจู TEFA4434 ูุฃูู ุฃูุฑุฏุฑ" />
          <p class="text-xs text-green-600 mt-1">
            ููุฏ ุฎุตู <span class="font-bold">TEFA4434</span> ูุนุทููู 10ูช ุฎุตู ุนูู ุฃูู ุฃูุฑุฏุฑ ุจููุณ ุฑูู ุงูููุจุงูู ๐
          </p>
        </div>
      </div>

      <button id="submitOrderBtn"
              class="w-full mt-3 bg-black text-white py-3 rounded-xl text-lg font-bold">
        ุชุฃููุฏ ุงูุทูุจ ุงูุขู
      </button>

      <p class="mt-2 text-center text-xs text-gray-500">
        ุงุทูุจูู ูุงูุชู ูุทูุฆูุฉ โ ุจุชุนุงููู ุจุฑุงุญุชู ูุจู ูุง ุชุณุชููู ๐ฅฐโค๏ธ
      </p>
    </section>

  </main>

  <!-- ุตูุช ุจุณูุท ุนูุฏ ุฅุถุงูุฉ ููุณูุฉ (ูู ุญุจูุช ุชุณุชุนููู ูู product.html) -->
  <audio id="addSound" preload="auto">
    <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" type="audio/ogg">
  </audio>

  <script>
    // ******** ุฅุนุฏุงุฏุงุช ุนุงูุฉ ********
    const SHEET_WEBHOOK_URL =
      "https://script.google.com/macros/s/AKfycbxDCEny0w1V8EVpFix56-7v_e930qLEWqz1aXKt5HOaDafo9NJJn8-k-RvGfjbzg-AN/exec";

    const CART_KEYS = ["tefa_cart", "tefaCart"]; // ุนูุดุงู ูู ุงูุตูุญุงุช ุงูุชุงููุฉ ุจุชุณุชุฎุฏู ุงุณู ูุฎุชูู

    function readCartFromStorage() {
      function toArray(raw) {
        try {
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
          return [];
        }
      }

      for (const key of CART_KEYS) {
        const raw = localStorage.getItem(key);
        if (raw) {
          const arr = toArray(raw);
          if (arr.length) return arr;
        }
      }
      return [];
    }

    function saveCartToStorage(cart) {
      const json = JSON.stringify(cart);
      for (const key of CART_KEYS) {
        localStorage.setItem(key, json);
      }
    }

    function clearCartFromStorage() {
      for (const key of CART_KEYS) {
        localStorage.removeItem(key);
      }
    }

    // ุชุญุฏูุซ ุนุฏุงุฏ ุงูุณูุฉ ูู ุงูููุฏุฑ
    function updateCartBadge(cart) {
      const badge = document.getElementById("cartBadge");
      const totalQty = cart.reduce((sum, item) => sum + (item.qty || 0), 0);
      badge.textContent = totalQty;
      badge.classList.toggle("hidden", totalQty === 0);
    }

    // ุญุณุงุจ ุงูุดุญู ุญุณุจ ุงููุญุงูุธุฉ
    function calcShipping(governorate) {
      if (!governorate) return 0;

      const high120 = [
        "ุดุฑู ุงูุดูุฎ",
        "ุงูุบุฑุฏูุฉ",
        "ูุฑุณู ูุทุฑูุญ",
        "ุดูุงู ุณููุงุก",
        "ุฌููุจ ุณููุงุก",
        "ุงููุงุฏู ุงูุฌุฏูุฏ"
      ];

      if (governorate === "ุงููุงูุฑุฉ" || governorate === "ุงูุฌูุฒุฉ") return 60;
      if (high120.includes(governorate)) return 120;
      return 70; // ุจุงูู ุงููุญุงูุธุงุช
    }

    // ุฑุณู ุนูุงุตุฑ ุงูุณูุฉ
    function renderCart() {
      const cart = readCartFromStorage();
      const container = document.getElementById("cartItemsContainer");
      const emptyMsg = document.getElementById("emptyMessage");
      const summaryBox = document.getElementById("summaryBox");
      const formSection = document.getElementById("orderFormSection");

      container.innerHTML = "";

      if (!cart.length) {
        emptyMsg.classList.remove("hidden");
        summaryBox.classList.add("hidden");
        formSection.classList.add("hidden");
        updateCartBadge(cart);
        return;
      }

      emptyMsg.classList.add("hidden");
      summaryBox.classList.remove("hidden");
      formSection.classList.remove("hidden");

      cart.forEach((item, index) => {
        const lineTotal = (item.price || 0) * (item.qty || 1);

        const div = document.createElement("div");
        div.className =
          "bg-white rounded-xl shadow p-3 flex items-center justify-between gap-3";

        div.innerHTML = `
          <div class="flex-1">
            <div class="font-bold text-sm mb-1">${item.name || "ููุชุฌ"}</div>
            <div class="flex items-center gap-2 text-xs text-gray-600 mb-2">
              <span>ุงูููู:</span>
              <span class="w-4 h-4 rounded-full border"
                    style="background:${item.colorCode || "#000"}"></span>
              <span>${item.color || ""}</span>
            </div>
            <div class="flex items-center gap-3 text-xs">
              <div class="flex items-center border rounded-full overflow-hidden">
                <button data-index="${index}" data-action="minus"
                        class="w-8 h-8 flex items-center justify-center">-</button>
                <span class="w-8 text-center text-sm">${item.qty || 1}</span>
                <button data-index="${index}" data-action="plus"
                        class="w-8 h-8 flex items-center justify-center">+</button>
              </div>
              <button data-index="${index}" data-action="remove"
                      class="text-red-500 text-xs underline">
                ุญุฐู ุงูููู
              </button>
            </div>
          </div>
          <div class="text-left text-sm font-bold whitespace-nowrap">
            ${lineTotal} ุฌ
          </div>
        `;

        container.appendChild(div);
      });

      // ุฃุญุฏุงุซ +/- ูุญุฐู
      container.querySelectorAll("button[data-action]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const idx = parseInt(btn.getAttribute("data-index"), 10);
          const action = btn.getAttribute("data-action");
          const currentCart = readCartFromStorage();
          const item = currentCart[idx];
          if (!item) return;

          if (action === "plus") {
            item.qty = (item.qty || 1) + 1;
          } else if (action === "minus") {
            item.qty = Math.max(1, (item.qty || 1) - 1);
          } else if (action === "remove") {
            currentCart.splice(idx, 1);
          }

          saveCartToStorage(currentCart);
          renderCart();
        });
      });

      updatePricesSummary();
      updateCartBadge(cart);
    }

    // ุญุณุงุจ ููุฎุต ุงูุฃุณุนุงุฑ (ุจุฏูู ุงุฑุณุงู)
    function updatePricesSummary() {
      const cart = readCartFromStorage();
      const productsTotal = cart.reduce(
        (sum, item) => sum + (item.price || 0) * (item.qty || 1),
        0
      );

      const governorate = document.getElementById("governorate").value;
      const shipping = calcShipping(governorate);

      const couponInput = document.getElementById("coupon");
      const coupon = couponInput ? couponInput.value.trim().toUpperCase() : "";
      let discount = 0;

      if (coupon === "TEFA4434") {
        discount = Math.round(productsTotal * 0.1);
      }

      const grand = productsTotal + shipping - discount;

      document.getElementById("productsTotal").textContent =
        productsTotal + " ุฌ";
      document.getElementById("discountAmount").textContent =
        discount + " ุฌ";
      document.getElementById("shippingAmount").textContent =
        shipping + " ุฌ";
      document.getElementById("grandTotal").textContent =
        grand + " ุฌ";

      return { productsTotal, shipping, discount, grand };
    }

    // ุฅุฑุณุงู ุงูุทูุจ ุฅูู Google Sheet
    async function submitOrder() {
      const cart = readCartFromStorage();
      if (!cart.length) {
        alert("ุงูุณูุฉ ูุงุถูุฉุ ุงุฎุชุงุฑู ููุชุฌ ูุงุญุฏ ุนูู ุงูุฃูู.");
        return;
      }

      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const phone2 = document.getElementById("phone2").value.trim();
      const governorate = document.getElementById("governorate").value.trim();
      const address = document.getElementById("address").value.trim();
      const notes = document.getElementById("notes").value.trim();
      const weight = document.getElementById("weight").value.trim();
      const height = document.getElementById("height").value.trim();
      const coupon = document.getElementById("coupon").value
        .trim()
        .toUpperCase();

      if (!name || !phone || !governorate || !address) {
        alert("ูู ูุถูู ุงููุฆู ุงูุงุณูุ ุฑูู ุงูููุจุงููุ ุงููุญุงูุธุฉุ ูุงูุนููุงู ุจุงููุงูู.");
        return;
      }

      const { productsTotal, shipping, discount, grand } =
        updatePricesSummary();

      const productsSummary = cart
        .map(
          (item) =>
            `${item.name || "ููุชุฌ"} - ููู: ${item.color || ""} - ูููุฉ: ${
              item.qty || 1
            }`
        )
        .join(" | ");

      const payload = {
        name,
        phone,
        phone2,
        governorate,
        address,
        notes,
        weight,
        height,
        coupon,
        products: productsSummary,
        total: grand,
        productsTotal,
        shipping,
        discount
      };

      const btn = document.getElementById("submitOrderBtn");
      btn.disabled = true;
      btn.textContent = "ุฌุงุฑู ุฅุฑุณุงู ุงูุทูุจ ...";

      try {
        const res = await fetch(SHEET_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("Network error");

        const data = await res.json().catch(() => ({}));

        if (data && data.result === "success") {
          alert("ุชู ุชุณุฌูู ุทูุจู ุจูุฌุงุญ โค๏ธ ูููููู ูุชุฃููุฏ ุงูุทูุจ.");
          clearCartFromStorage();
          renderCart();
        } else {
          alert(
            "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุงูุทูุจ. ูู ุณูุญุชู ูููููุง ุนูู ูุงุชุณุงุจ ูุชุฃููุฏ ุทูุจู."
          );
        }
      } catch (err) {
        console.error(err);
        alert(
          "ูู ูุดููุฉ ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช ุฃู Google Sheet. ูู ุณูุญุชู ูููููุง ุนูู ูุงุชุณุงุจ ูุชุฃููุฏ ุทูุจู."
        );
      } finally {
        btn.disabled = false;
        btn.textContent = "ุชุฃููุฏ ุงูุทูุจ ุงูุขู";
      }
    }

    // listeners ุนุงูุฉ
    document.addEventListener("DOMContentLoaded", () => {
      renderCart();

      const govSelect = document.getElementById("governorate");
      govSelect.addEventListener("change", updatePricesSummary);

      const couponInput = document.getElementById("coupon");
      couponInput.addEventListener("input", () => {
        // ูุฌุฑุฏ ุชุญุฏูุซ ููุฑู ุนูุฏ ุชุบููุฑ ุงูููุฏ
        updatePricesSummary();
      });

      document
        .getElementById("submitOrderBtn")
        .addEventListener("click", submitOrder);
    });
  </script>
</body>
</html>