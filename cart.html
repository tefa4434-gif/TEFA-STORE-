<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ุณูุฉ ุงูุทูุจุงุช | TEFA STORE</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

  <!-- ุงูููุฏุฑ -->
  <header class="bg-white shadow">
    <div class="max-w-5xl mx-auto flex items-center justify-between px-4 py-3">
      <a href="index.html" class="flex items-center gap-2">
        <span class="bg-black text-white rounded-full w-9 h-9 flex items-center justify-center text-sm font-bold">TS</span>
        <div>
          <h1 class="text-lg font-bold">TEFA STORE</h1>
          <p class="text-xs text-gray-500">ูุชุฌุฑ ุฃุทูู ุญุฑููู ุฑูุฒุงููู ู ููุฑูุงู</p>
        </div>
      </a>

      <!-- ุฃููููุฉ ุงูุณูุฉ + ุงูุดุงุฑุฉ -->
      <a href="cart.html" class="relative">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M6 6h15l-1.5 9h-13z" stroke-width="1.6" />
          <circle cx="9" cy="20" r="1.4" />
          <circle cx="18" cy="20" r="1.4" />
          <path d="M6 6 5 3H3" stroke-width="1.6" />
        </svg>
        <span id="cart-count"
              class="absolute -top-2 -left-2 bg-red-500 text-white text-[11px] min-w-[18px] h-[18px] flex items-center justify-center rounded-full px-[3px]">
          0
        </span>
      </a>
    </div>
  </header>

  <!-- ุงููุญุชูู -->
  <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">

    <h2 class="text-2xl font-extrabold text-gray-900 mb-2">ุณูุฉ ุงูุทูุจุงุช</h2>
    <p class="text-sm text-gray-500 mb-4">
      ุฑุงุฌุนู ุงูุฃููุงู ูุงููููุงุชุ ุซู ุงุฏุฎูู ุจูุงูุงุช ุงูุชูุตูู ูุงุถุบุทู <span class="font-semibold">ุชุฃููุฏ ุงูุทูุจ</span>.
    </p>

    <!-- ุฑุณุงูุฉ ูุงุถูุฉ -->
    <div id="empty-cart" class="hidden bg-white rounded-2xl p-6 shadow text-center">
      <p class="text-lg font-semibold mb-2">ุงูุณูุฉ ูุงุถูุฉ ุญุชู ุงูุขู ๐งบ</p>
      <p class="text-sm text-gray-500 mb-4">ุงุฎุชุงุฑู ุงูููุฏูู ูุงูููู ูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ูุงุจุฏุฆู ุฃูู ุทูุจ ูููู.</p>
      <a href="index.html" class="inline-block bg-black text-white rounded-xl px-5 py-2 text-sm font-semibold">
        ุฑุฌูุน ููููุชุฌุงุช
      </a>
    </div>

    <div id="cart-wrapper" class="grid gap-6 lg:grid-cols-3">
      <!-- ูุงุฆูุฉ ุงูููุชุฌุงุช -->
      <section class="lg:col-span-2 space-y-3" id="cart-items">
        <!-- ุงูุนูุงุตุฑ ุจุชุชุญุท ููุง ูู ุฌุงูุงุณูุฑูุจุช -->
      </section>

      <!-- ููุฎุต ุงูุทูุจ + ูููุฐุฌ ุงูุจูุงูุงุช -->
      <section class="space-y-4">

        <!-- ููุฎุต ุงูุฃุณุนุงุฑ -->
        <div class="bg-white rounded-2xl p-4 shadow space-y-3">
          <h3 class="font-bold text-lg mb-1">ููุฎุต ุงูุทูุจ</h3>

          <div class="flex justify-between text-sm">
            <span>ุฅุฌูุงูู ุงูููุชุฌุงุช</span>
            <span id="summary-subtotal">0 ุฌ</span>
          </div>

          <div class="flex justify-between text-sm">
            <span>ุณุนุฑ ุงูุดุญู</span>
            <span id="summary-shipping">โ</span>
          </div>

          <div class="flex justify-between text-sm text-emerald-700">
            <span>ุฎุตู ููุฏ TEFA4434</span>
            <span id="summary-discount">0 ุฌ</span>
          </div>

          <hr class="my-2">

          <div class="flex justify-between text-base font-extrabold">
            <span>ุงูุฅุฌูุงูู ุจุนุฏ ุงูุฎุตู</span>
            <span id="summary-total">0 ุฌ</span>
          </div>

          <p class="text-[11px] text-gray-500 mt-1 leading-relaxed">
            ููุฏ ุฎุตู <span class="font-bold text-black">TEFA4434</span> ูุฎุตู 10ูช ุนูู ุฃูู ุฃูุฑุฏุฑ ุจููุณ ุฑูู ุงูููุจุงูู ๐ฅ
          </p>
        </div>

        <!-- ุจูุงูุงุช ุงูุนููู -->
        <form id="order-form" class="bg-white rounded-2xl p-4 shadow space-y-3">

          <h3 class="font-bold text-lg mb-2">ุจูุงูุงุช ุงูุชูุตูู</h3>

          <div class="space-y-1">
            <label class="text-sm font-semibold">ุงูุงุณู ุงููุงูู</label>
            <input type="text" id="name" required
                   class="w-full rounded-xl border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black">
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1">
              <label class="text-sm font-semibold">ุฑูู ุงูููุจุงูู</label>
              <input type="tel" id="phone" required
                     class="w-full rounded-xl border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black"
                     placeholder="01xxxxxxxxx">
            </div>
            <div class="space-y-1">
              <label class="text-sm text-gray-700">ุฑูู ุฅุถุงูู (ุงุฎุชูุงุฑู)</label>
              <input type="tel" id="phone2"
                     class="w-full rounded-xl border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-400"
                     placeholder="01xxxxxxxxx">
            </div>
          </div>

          <div class="space-y-1">
            <label class="text-sm font-semibold">ุงููุญุงูุธุฉ</label>
            <select id="governorate" required
                    class="w-full rounded-xl border border-gray-200 px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-black">
              <option value="">ุงุฎุชุงุฑู ุงููุญุงูุธุฉ</option>
              <option>ุงููุงูุฑุฉ</option>
              <option>ุงูุฌูุฒุฉ</option>
              <option>ุงูุฅุณููุฏุฑูุฉ</option>
              <option>ุงูุฏููููุฉ</option>
              <option>ุงูุดุฑููุฉ</option>
              <option>ุงููููููุฉ</option>
              <option>ุงูููููุจูุฉ</option>
              <option>ุงูุบุฑุจูุฉ</option>
              <option>ููุฑ ุงูุดูุฎ</option>
              <option>ุงูุจุญูุฑุฉ</option>
              <option>ุฏููุงุท</option>
              <option>ุจูุฑุณุนูุฏ</option>
              <option>ุงูุฅุณูุงุนูููุฉ</option>
              <option>ุงูุณููุณ</option>
              <option>ุงููููู</option>
              <option>ุจูู ุณููู</option>
              <option>ุงููููุง</option>
              <option>ุฃุณููุท</option>
              <option>ุณููุงุฌ</option>
              <option>ููุง</option>
              <option>ุงูุฃูุตุฑ</option>
              <option>ุฃุณูุงู</option>
              <option>ุงูุจุญุฑ ุงูุฃุญูุฑ</option>
              <option>ูุฑุณู ูุทุฑูุญ</option>
              <option>ุดูุงู ุณููุงุก</option>
              <option>ุฌููุจ ุณููุงุก</option>
              <option>ุงููุงุฏู ุงูุฌุฏูุฏ</option>
              <option>ุดุฑู ุงูุดูุฎ</option>
              <option>ุงูุบุฑุฏูุฉ</option>
            </select>
          </div>

          <div class="space-y-1">
            <label class="text-sm font-semibold">ุงูุนููุงู ุจุงูุชูุตูู</label>
            <textarea id="address" required rows="2"
                      class="w-full rounded-xl border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black"
                      placeholder="ุงุณู ุงูุดุงุฑุน โ ุฑูู ุงูููุฒู โ ุฃูุฑุจ ุนูุงูุฉ ูููุฒุฉ"></textarea>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1">
              <label class="text-sm text-gray-700">ุงููุฒู (ุงุฎุชูุงุฑู)</label>
              <input type="text" id="weight"
                     class="w-full rounded-xl border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-400">
            </div>
            <div class="space-y-1">
              <label class="text-sm text-gray-700">ุงูุทูู (ุงุฎุชูุงุฑู)</label>
              <input type="text" id="height"
                     class="w-full rounded-xl border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-400">
            </div>
          </div>

          <div class="space-y-1">
            <label class="text-sm text-gray-700">ููุงุญุธุงุช (ุงุฎุชูุงุฑู)</label>
            <textarea id="notes" rows="2"
                      class="w-full rounded-xl border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-400"
                      placeholder="ูู ุญุงุจุฉ ุชูุตูุฉ ูุนููุฉ ูููุงุจุชู ุฃู ููุงุนูุฏ ุงุณุชูุงู ูุนููุฉ ุงูุชุจููุง ููุง"></textarea>
          </div>

          <div class="space-y-1">
            <label class="text-sm font-semibold">ููุฏ ุงูุฎุตู</label>
            <input type="text" id="coupon" value="TEFA4434"
                   class="w-full rounded-xl border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black">
          </div>

          <button type="submit"
                  class="w-full mt-2 bg-black text-white rounded-xl py-3 text-sm font-semibold flex items-center justify-center gap-2"
                  id="submit-btn">
            <span id="submit-text">ุชุฃููุฏ ุงูุทูุจ ุงูุขู</span>
            <span id="submit-spinner" class="hidden animate-spin border-2 border-white border-t-transparent rounded-full w-4 h-4"></span>
          </button>

          <p class="text-[11px] text-gray-500 text-center mt-1">
            ุงุทูุจ ูุงูุช ูุทูุฆู โค ุนุงูู ุจุฑุงุญุชู ูุจู ุงูุงุณุชูุงู โ ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู.
          </p>
        </form>
      </section>
    </div>
  </main>

  <!-- ุตูุช ุจุณูุท ุนูุฏ ูุฌุงุญ ุงูุทูุจ -->
  <audio id="success-sound">
    <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" type="audio/ogg">
  </audio>

  <!-- ุณูุฑุจุช ุงูุณูุฉ -->
  <script>
    const CART_KEY = "tefa_cart";
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDCEny0w1V8EVpFix56-7v_e930qLEWqz1aXKt5HOaDafo9NJJn8-k-RvGfjbzg-AN/exec";

    let cart = [];

    function loadCart() {
      try {
        cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
      } catch (e) {
        cart = [];
      }
    }

    function saveCart() {
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
    }

    function getItemFields(item) {
      return {
        name: item.name || item.productName || "ููุชุฌ ุจุฏูู ุงุณู",
        price: Number(item.price || item.unitPrice || 0),
        quantity: Number(item.quantity || item.qty || 1),
        colorName: item.colorName || item.color || "",
        colorHex: item.colorHex || item.hex || "#111",
      };
    }

    function updateCartBadge() {
      const badge = document.getElementById("cart-count");
      const totalPieces = cart.reduce((sum, item) => {
        const { quantity } = getItemFields(item);
        return sum + quantity;
      }, 0);
      badge.textContent = totalPieces;
      badge.classList.toggle("hidden", totalPieces === 0);
    }

    function formatPrice(num) {
      return `${num.toFixed(0)} ุฌ`;
    }

    function renderCart() {
      const itemsContainer = document.getElementById("cart-items");
      const emptyBox = document.getElementById("empty-cart");
      const wrapper = document.getElementById("cart-wrapper");

      if (!cart.length) {
        emptyBox.classList.remove("hidden");
        wrapper.classList.add("hidden");
        updateSummary();
        updateCartBadge();
        return;
      } else {
        emptyBox.classList.add("hidden");
        wrapper.classList.remove("hidden");
      }

      itemsContainer.innerHTML = "";
      cart.forEach((item, index) => {
        const { name, price, quantity, colorName, colorHex } = getItemFields(item);
        const lineTotal = price * quantity;

        const div = document.createElement("div");
        div.className = "bg-white rounded-2xl p-3 shadow flex gap-3 items-center";

        div.innerHTML = `
          <div class="w-16 h-20 rounded-xl bg-gray-100 overflow-hidden flex-shrink-0">
            ${item.image ? `<img src="${item.image}" class="w-full h-full object-cover" alt="${name}">` :
              `<div class="w-full h-full flex items-center justify-center text-[11px] text-gray-400">ุจุฏูู ุตูุฑุฉ</div>`}
          </div>

          <div class="flex-1 space-y-1">
            <div class="flex justify-between items-start gap-2">
              <div>
                <h4 class="text-sm font-semibold text-gray-900">${name}</h4>
                <div class="flex items-center gap-2 mt-1">
                  ${colorName ? `
                    <span class="w-4 h-4 rounded-full border border-gray-300 inline-block" style="background-color:${colorHex};"></span>
                    <span class="text-[11px] text-gray-600">ุงูููู: ${colorName}</span>
                  ` : ""}
                </div>
              </div>
              <button class="text-xs text-red-500 hover:text-red-700 font-semibold" data-remove="${index}">
                ุญุฐู
              </button>
            </div>

            <div class="flex justify-between items-center mt-2">
              <div class="flex items-center gap-2">
                <button class="w-7 h-7 rounded-full border border-gray-300 flex items-center justify-center text-sm" data-dec="${index}">โ</button>
                <span class="text-sm font-semibold">${quantity}</span>
                <button class="w-7 h-7 rounded-full border border-gray-300 flex items-center justify-center text-sm" data-inc="${index}">+</button>
              </div>
              <div class="text-sm font-bold text-gray-900">
                ${formatPrice(lineTotal)}
              </div>
            </div>
          </div>
        `;

        itemsContainer.appendChild(div);
      });

      itemsContainer.addEventListener("click", handleCartButtons);
      updateCartBadge();
      updateSummary();
    }

    function handleCartButtons(e) {
      const decIndex = e.target.getAttribute("data-dec");
      const incIndex = e.target.getAttribute("data-inc");
      const removeIndex = e.target.getAttribute("data-remove");

      if (decIndex !== null) {
        const i = Number(decIndex);
        const { quantity } = getItemFields(cart[i]);
        if (quantity > 1) {
          cart[i].quantity = quantity - 1;
        }
        saveCart();
        rerender();
      }

      if (incIndex !== null) {
        const i = Number(incIndex);
        const { quantity } = getItemFields(cart[i]);
        cart[i].quantity = quantity + 1;
        saveCart();
        rerender();
      }

      if (removeIndex !== null) {
        const i = Number(removeIndex);
        cart.splice(i, 1);
        saveCart();
        rerender();
      }
    }

    function getSubtotal() {
      return cart.reduce((sum, item) => {
        const { price, quantity } = getItemFields(item);
        return sum + price * quantity;
      }, 0);
    }

    function getShipping(governorate) {
      const highCost = [
        "ุดุฑู ุงูุดูุฎ",
        "ุงูุบุฑุฏูุฉ",
        "ูุฑุณู ูุทุฑูุญ",
        "ุดูุงู ุณููุงุก",
        "ุฌููุจ ุณููุงุก",
        "ุงููุงุฏู ุงูุฌุฏูุฏ"
      ];
      if (!governorate) return 0;
      if (governorate === "ุงููุงูุฑุฉ" || governorate === "ุงูุฌูุฒุฉ") return 60;
      if (highCost.includes(governorate)) return 120;
      return 70;
    }

    function getDiscount(subtotal, coupon, phone) {
      if (!coupon) return 0;
      coupon = coupon.trim().toUpperCase();
      if (coupon !== "TEFA4434") return 0;

      const flagKey = `discount_used_${phone}`;
      if (localStorage.getItem(flagKey)) {
        // ููุณ ุงูุฑูู ุงุณุชุฎุฏู ุงูุฎุตู ูุจู ูุฏู ุนูู ูุฐุง ุงูุฌูุงุฒ
        return 0;
      }
      return subtotal * 0.10; // 10%
    }

    function updateSummary() {
      const subtotal = getSubtotal();
      const gov = document.getElementById("governorate").value;
      const shipping = getShipping(gov);
      const coupon = document.getElementById("coupon").value || "";
      const phone = document.getElementById("phone").value || "";
      const discount = getDiscount(subtotal, coupon, phone);
      const total = subtotal + shipping - discount;

      document.getElementById("summary-subtotal").textContent = formatPrice(subtotal);
      document.getElementById("summary-shipping").textContent = shipping ? formatPrice(shipping) : "ุญุฏุฏู ุงููุญุงูุธุฉ";
      document.getElementById("summary-discount").textContent = discount ? `- ${formatPrice(discount)}` : "0 ุฌ";
      document.getElementById("summary-total").textContent = formatPrice(Math.max(total, 0));
    }

    function rerender() {
      // remove old handlers to avoid duplication
      const itemsContainer = document.getElementById("cart-items");
      const newContainer = itemsContainer.cloneNode(false);
      itemsContainer.parentNode.replaceChild(newContainer, itemsContainer);
      renderCart();
    }

    document.getElementById("governorate").addEventListener("change", updateSummary);
    document.getElementById("coupon").addEventListener("input", () => {
      // ูุน ุชุบูุฑ ุงูููุฏ ูุนุงุฏ ุญุณุงุจ ุงูุฎุตู
      updateSummary();
    });
    document.getElementById("phone").addEventListener("input", updateSummary);

    // ุฅุฑุณุงู ุงูุทูุจ
    document.getElementById("order-form").addEventListener("submit", async function (e) {
      e.preventDefault();

      if (!cart.length) {
        alert("ุงูุณูุฉ ูุงุถูุฉุ ูู ูุถูู ุงุถููู ููุชุฌ ูุงุญุฏ ุนูู ุงูุฃูู.");
        return;
      }

      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const phone2 = document.getElementById("phone2").value.trim();
      const governorate = document.getElementById("governorate").value;
      const address = document.getElementById("address").value.trim();
      const notes = document.getElementById("notes").value.trim();
      const weight = document.getElementById("weight").value.trim();
      const height = document.getElementById("height").value.trim();
      const coupon = document.getElementById("coupon").value.trim().toUpperCase();

      if (!name || !phone || !governorate || !address) {
        alert("ูู ูุถูู ุงุฏุฎูู ูู ุจูุงูุงุช ุงูุชูุตูู ุงูุฃุณุงุณูุฉ.");
        return;
      }

      const subtotal = getSubtotal();
      const shipping = getShipping(governorate);
      const discount = getDiscount(subtotal, coupon, phone);
      const total = subtotal + shipping - discount;

      if (!shipping) {
        alert("ูู ูุถูู ุงุฎุชุงุฑู ุงููุญุงูุธุฉ ุจุดูู ุตุญูุญ.");
        return;
      }

      const productsText = cart.map(item => {
        const { name, quantity, colorName } = getItemFields(item);
        return `ุงูููุชุฌ: ${name} | ุงูููู: ${colorName || "-"} | ุงููููุฉ: ${quantity}`;
      }).join(" || ");

      const orderData = {
        name,
        phone,
        phone2,
        governorate,
        address,
        notes: notes + (weight || height ? ` | ูุฒู: ${weight || "-"} | ุทูู: ${height || "-"}` : ""),
        products: productsText,
        shipping,
        total: Math.max(total, 0),
        subtotal,
        discount,
        coupon
      };

      const btn = document.getElementById("submit-btn");
      const textSpan = document.getElementById("submit-text");
      const spinner = document.getElementById("submit-spinner");

      btn.disabled = true;
      btn.classList.add("opacity-75");
      spinner.classList.remove("hidden");
      textSpan.textContent = "ุฌุงุฑู ุชุฃููุฏ ุงูุทูุจ...";

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(orderData)
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || data.status === "error") {
          throw new Error(data.message || "ุฎุทุฃ ุบูุฑ ูุนุฑูู");
        }

        // ุญูุธ ุฅู ุงูููุฏ ุงุชุณุชุฎุฏู ููุฐุง ุงูุฑูู ุนูู ูุฐุง ุงูุฌูุงุฒ
        if (coupon === "TEFA4434" && discount > 0) {
          localStorage.setItem(`discount_used_${phone}`, "1");
        }

        // ุชูุฑูุบ ุงูุณูุฉ
        cart = [];
        saveCart();
        rerender();

        // ุตูุช ูุฌุงุญ
        const sound = document.getElementById("success-sound");
        if (sound) sound.play().catch(() => {});

        alert("ุชู ุชุณุฌูู ุทูุจู ุจูุฌุงุญ โค๏ธ ูุฑูู TEFA STORE ููุชูุงุตู ูุนุงูู ูุชุฃููุฏ ุงูุฃูุฑุฏุฑ.");

      } catch (error) {
        console.error(error);
        alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุงูุทูุจุ ูู ุงุณุชูุฑุช ุงููุดููุฉ ุชูุงุตูู ูุนุงูุง ุนูู ุงููุงุชุณุงุจ.");
      } finally {
        btn.disabled = false;
        btn.classList.remove("opacity-75");
        spinner.classList.add("hidden");
        textSpan.textContent = "ุชุฃููุฏ ุงูุทูุจ ุงูุขู";
      }
    });

    // ุชุญููู ุงูุณูุฉ ุนูุฏ ูุชุญ ุงูุตูุญุฉ
    document.addEventListener("DOMContentLoaded", () => {
      loadCart();
   