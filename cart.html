<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>TEFA STORE | ุฅุชูุงู ุงูุทูุจ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 font-sans">

<header class="bg-white shadow p-4 flex justify-between items-center sticky top-0 z-40">
  <a href="index.html" class="text-sm">โฌ ุงูุฑุฌูุน ูููุชุฌุฑ</a>
  <h1 class="text-xl font-extrabold">ุฅุชูุงู ุงูุทูุจ</h1>
  <span class="text-2xl">๐</span>
</header>

<main class="max-w-md mx-auto p-4 space-y-4">

  <!-- ููุฎุต ุงูุณูุฉ -->
  <section class="bg-white rounded-2xl shadow p-4">
    <h2 class="text-lg font-bold mb-3">ุณูุฉ ุงููุดุชุฑูุงุช</h2>
    <div id="cartItems" class="space-y-3 mb-3"></div>

    <p id="emptyMsg" class="text-center text-sm text-gray-500 hidden">
      ุงูุณูุฉ ูุงุฑุบุฉุ ุฑุฌูุน ููุตูุญุฉ ุงูุฑุฆูุณูุฉ ูุงุฎุชูุงุฑ ุงูููุชุฌุงุช.
    </p>

    <div id="totalsBox" class="border-t pt-3 mt-3 text-sm space-y-1">
      <div class="flex justify-between">
        <span>ุฅุฌูุงูู ุงูููุชุฌุงุช:</span>
        <span id="itemsTotal">0 ุฌ</span>
      </div>
      <div class="flex justify-between">
        <span>ุงูุดุญู:</span>
        <span id="shippingTotal">0 ุฌ</span>
      </div>
      <div class="flex justify-between text-green-700">
        <span>ุฎุตู ุงูููุจูู:</span>
        <span id="discountValue">0 ุฌ</span>
      </div>
      <div class="flex justify-between font-extrabold text-lg mt-1">
        <span>ุงูุฅุฌูุงูู ุจุนุฏ ุงูุฎุตู:</span>
        <span id="grandTotal">0 ุฌ</span>
      </div>
    </div>
  </section>

  <!-- ุจูุงูุงุช ุงูุนููู -->
  <section class="bg-white rounded-2xl shadow p-4">
    <h2 class="text-lg font-bold mb-3">ุจูุงูุงุช ุงูุงุณุชูุงู</h2>

    <form id="orderForm" class="space-y-3 text-right">

      <div>
        <label class="block text-sm mb-1">ุงูุงุณู ุงููุงูู</label>
        <input id="name" class="w-full border rounded-lg p-2 text-sm" required>
      </div>

      <div>
        <label class="block text-sm mb-1">ุฑูู ุงูุชููููู 1</label>
        <input id="phone1" class="w-full border rounded-lg p-2 text-sm" required>
      </div>

      <div>
        <label class="block text-sm mb-1">ุฑูู ุงูุชููููู 2 (ุงุฎุชูุงุฑู)</label>
        <input id="phone2" class="w-full border rounded-lg p-2 text-sm">
      </div>

      <div>
        <label class="block text-sm mb-1">ุงููุญุงูุธุฉ</label>
        <select id="governorate" class="w-full border rounded-lg p-2 text-sm" required>
          <option value="">ุงุฎุชุฑ ุงููุญุงูุธุฉ</option>
          <option>ุงููุงูุฑุฉ</option>
          <option>ุงูุฌูุฒุฉ</option>
          <option>ุงูุฅุณููุฏุฑูุฉ</option>
          <option>ุงูุฏููููุฉ</option>
          <option>ุงูุดุฑููุฉ</option>
          <option>ุงูุบุฑุจูุฉ</option>
          <option>ุงููููููุฉ</option>
          <option>ุงูุจุญูุฑุฉ</option>
          <option>ููุฑ ุงูุดูุฎ</option>
          <option>ุงูููููุจูุฉ</option>
          <option>ุจูุฑุณุนูุฏ</option>
          <option>ุงูุฅุณูุงุนูููุฉ</option>
          <option>ุงูุณููุณ</option>
          <option>ุฏููุงุท</option>
          <option>ุงููููุง</option>
          <option>ุฃุณููุท</option>
          <option>ุณููุงุฌ</option>
          <option>ููุง</option>
          <option>ุงูุฃูุตุฑ</option>
          <option>ุฃุณูุงู</option>
          <option>ุจูู ุณููู</option>
          <option>ุงููููู</option>
          <option>ุงูุจุญุฑ ุงูุฃุญูุฑ</option>
          <option>ุงููุงุฏู ุงูุฌุฏูุฏ</option>
          <option>ูุทุฑูุญ</option>
          <option>ุดูุงู ุณููุงุก</option>
          <option>ุฌููุจ ุณููุงุก</option>
        </select>
      </div>

      <div>
        <label class="block text-sm mb-1">ุงูุนููุงู ุจุงูุชูุตูู</label>
        <textarea id="address" class="w-full border rounded-lg p-2 text-sm" rows="2" required></textarea>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">ุงููุฒู (ุงุฎุชูุงุฑู)</label>
          <input id="weight" class="w-full border rounded-lg p-2 text-sm" placeholder="ูุซุงู: 70">
        </div>
        <div>
          <label class="block text-sm mb-1">ุงูุทูู (ุงุฎุชูุงุฑู)</label>
          <input id="height" class="w-full border rounded-lg p-2 text-sm" placeholder="ูุซุงู: 165">
        </div>
      </div>

      <div>
        <label class="block text-sm mb-1">ููุงุญุธุงุช (ุงุฎุชูุงุฑู)</label>
        <textarea id="notes" class="w-full border rounded-lg p-2 text-sm" rows="2"></textarea>
      </div>

      <!-- ููุฏ ุงูุฎุตู -->
      <div class="border-t pt-3 mt-3">
        <label class="block text-sm mb-1">
          ููุฏ ุงูุฎุตู (ุงุฎุชูุงุฑู) โ <span class="font-bold text-green-700">TEFA4434</span>
        </label>
        <input id="coupon" class="w-full border rounded-lg p-2 text-sm" placeholder="ุงูุชุจ ููุฏ ุงูุฎุตู ุฅู ูุฌุฏ">
        <p id="couponMsg" class="text-xs mt-1 h-4"></p>
      </div>

      <button
        class="w-full bg-black text-white py-3 rounded-2xl text-lg font-extrabold mt-2">
        ุฅููุงุก ุงูุทูุจ
      </button>

      <p id="formMsg" class="text-center text-sm mt-2 h-5"></p>

    </form>
  </section>
</main>

<script>
// ==== ุชุญููู ุงูุณูุฉ ูู localStorage ====
function loadCart() {
  try {
    return JSON.parse(localStorage.getItem("cart") || "[]");
  } catch (e) {
    return [];
  }
}
function saveCart(cart) {
  localStorage.setItem("cart", JSON.stringify(cart));
}

const cart = loadCart();
const cartItemsEl   = document.getElementById("cartItems");
const emptyMsgEl    = document.getElementById("emptyMsg");
const itemsTotalEl  = document.getElementById("itemsTotal");
const shippingEl    = document.getElementById("shippingTotal");
const discountEl    = document.getElementById("discountValue");
const grandTotalEl  = document.getElementById("grandTotal");
const governorateEl = document.getElementById("governorate");
const couponInput   = document.getElementById("coupon");
const couponMsg     = document.getElementById("couponMsg");
const formMsg       = document.getElementById("formMsg");

let itemsTotal = 0;
let shipping   = 0;
let discount   = 0;
let grandTotal = 0;

// ุฑุณู ูุญุชูู ุงูุณูุฉ
function renderCart() {
  cartItemsEl.innerHTML = "";
  itemsTotal = 0;

  if (!cart.length) {
    emptyMsgEl.classList.remove("hidden");
  } else {
    emptyMsgEl.classList.add("hidden");
  }

  cart.forEach((item, index) => {
    const lineTotal = item.price * item.qty;
    itemsTotal += lineTotal;

    const div = document.createElement("div");
    div.className = "flex justify-between items-center border rounded-xl p-2";
    div.innerHTML = `
      <div class="text-sm">
        <div class="font-bold">${item.name}</div>
        <div class="text-xs text-gray-600">ุงูููู: ${item.color}</div>
        <div class="text-xs text-gray-600">ุงููููุฉ: ${item.qty}</div>
      </div>
      <div class="text-sm font-semibold">${lineTotal} ุฌ</div>
    `;
    cartItemsEl.appendChild(div);
  });

  updateTotals();
}

// ุญุณุงุจ ุงูุดุญู
function calcShipping() {
  const gov = governorateEl.value || "";
  if (!cart.length) return 0;
  if (gov.includes("ุงููุงูุฑุฉ")) return 60; // ุงููุงูุฑุฉ 60
  return 70; // ุจุงูู ุงููุญุงูุธุงุช 70
}

// ุงูุชุญูู ูู ุฑูู ุงููุงุชู ุฃุฎุฐ ุฎุตู ูุจู ูุฏู
function isFirstOrderForPhone(phone) {
  try {
    const orders = JSON.parse(localStorage.getItem("orders") || "[]");
    return !orders.some(o =>
      (o.phone1 && o.phone1.trim() === phone) ||
      (o.phone2 && o.phone2.trim() === phone)
    );
  } catch (e) {
    return true;
  }
}

// ุญุณุงุจ ุงูุฎุตู ูุงูุฅุฌูุงูู
function updateTotals() {
  const gov = governorateEl.value || "";
  shipping = calcShipping();

  // ุญุณุงุจ ุงูุฎุตู ุจูุงุกู ุนูู ุงูููุฏ
  const code = (couponInput.value || "").trim().toUpperCase();
  discount = 0;
  couponMsg.textContent = "";
  couponMsg.className = "text-xs mt-1 h-4";

  if (code) {
    if (code === "TEFA4434") {
      // ูููุฑุฑ ุฅุฐุง ููุทุจู ุงูุฎุตู ุนูุฏ ุญูุธ ุงูุฃูุฑุฏุฑ ูุนูููุง
      couponMsg.textContent = "ุณูุชู ุชุทุจูู ุฎุตู 10ูช ุฅุฐุง ูุงู ูุฐุง ุฃูู ุทูุจ ุจูุฐุง ุงูุฑูู.";
      couponMsg.classList.add("text-green-700");
    } else {
      couponMsg.textContent = "ููุฏ ุงูุฎุตู ุบูุฑ ุตุญูุญ.";
      couponMsg.classList.add("text-red-600");
    }
  }

  grandTotal = itemsTotal + shipping - discount;

  itemsTotalEl.textContent = itemsTotal + " ุฌ";
  shippingEl.textContent   = shipping + " ุฌ";
  discountEl.textContent   = discount + " ุฌ";
  grandTotalEl.textContent = grandTotal + " ุฌ";
}

governorateEl.addEventListener("change", updateTotals);
couponInput.addEventListener("input", updateTotals);

// ุฃูู ุฑุณู
renderCart();

// ==== ุญูุธ ุงูุทูุจ ูู localStorage ====
const orderForm = document.getElementById("orderForm");

orderForm.addEventListener("submit", function (e) {
  e.preventDefault();
  if (!cart.length) {
    formMsg.textContent = "ุงูุณูุฉ ูุงุฑุบุฉุ ุฃุถู ููุชุฌุงุช ุฃููุงู.";
    formMsg.className = "text-center text-sm mt-2 text-red-600";
    return;
  }

  const name    = document.getElementById("name").value.trim();
  const phone1  = document.getElementById("phone1").value.trim();
  const phone2  = document.getElementById("phone2").value.trim();
  const gov     = governorateEl.value;
  const address = document.getElementById("address").value.trim();
  const weight  = document.getElementById("weight").value.trim();
  const height  = document.getElementById("height").value.trim();
  const notes   = document.getElementById("notes").value.trim();
  const code    = (couponInput.value || "").trim().toUpperCase();

  if (!name || !phone1 || !gov || !address) {
    formMsg.textContent = "ูู ูุถูู ุฃููู ุงูุจูุงูุงุช ุงููุทููุจุฉ.";
    formMsg.className = "text-center text-sm mt-2 text-red-600";
    return;
  }

  // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุฌูุงููุงุช
  itemsTotal = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
  shipping   = calcShipping();
  discount   = 0;

  let discountApplied = false;

  if (code === "TEFA4434" && isFirstOrderForPhone(phone1)) {
    discount = Math.round((itemsTotal + shipping) * 0.10); // 10ูช ุชูุฑูุจุง
    discountApplied = true;
  }

  grandTotal = itemsTotal + shipping - discount;

  // ูุต ููุฎุต ุงูููุชุฌุงุช
  const productSummary = cart.map(i =>
    `${i.name} - ููู: ${i.color} - ุนุฏุฏ: ${i.qty} - ${i.price * i.qty}ุฌ`
  ).join("\n");

  const order = {
    id: Date.now(),
    name,
    phone1,
    phone2,
    governorate: gov,
    address,
    weight,
    height,
    notes,
    product: productSummary,
    items: cart,
    itemsTotal,
    shipping,
    discount,
    discountCode: discountApplied ? code : "",
    total: grandTotal,
    timestamp: Date.now(),
    time: new Date().toLocaleString("ar-EG")
  };

  // ุญูุธ ูู localStorage
  let orders = [];
  try {
    orders = JSON.parse(localStorage.getItem("orders") || "[]");
  } catch (e) {
    orders = [];
  }
  orders.push(order);
  localStorage.setItem("orders", JSON.stringify(orders));

  // ุชุญุฏูุซ ุงูุนุฑุถ ุจุนุฏ ุงูุฎุตู
  discountEl.textContent = discount + " ุฌ";
  grandTotalEl.textContent = grandTotal + " ุฌ";

  // ุชูุฑูุบ ุงูุณูุฉ
  saveCart([]);
  cart.length = 0;
  renderCart();

  formMsg.textContent = discountApplied
    ? "ุชู ุชุณุฌูู ุงูุทูุจ ูุน ุฎุตู 10ูช ูู ูุฃูู ุทูุจ ๐"
    : "ุชู ุชุณุฌูู ุงูุทูุจ ุจูุฌุงุญ โ";
  formMsg.className = "text-center text-sm mt-2 text-green-700";

  orderForm.reset();
  governorateEl.value = gov; // ูุฎููู ุฒู ูุง ูู ุนุดุงู ุงูุดุญู
  updateTotals();
});
</script>

</body>
</html>