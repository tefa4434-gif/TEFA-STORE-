<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>TEFA STORE | ุณูุฉ ุงูุทูุจุงุช</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

  <!-- ุงูููุฏุฑ -->
  <header class="bg-black text-white py-3 shadow">
    <div class="max-w-5xl mx-auto px-4 flex items-center justify-between">
      <a href="index.html" class="font-bold text-xl">TEFA STORE</a>

      <!-- ุฃููููุฉ ุงูุณูุฉ ูุน ุงูุนุฏุงุฏ -->
      <a href="cart.html" class="relative flex items-center gap-2">
        <span class="text-sm">ุณูุฉ ุงูุทูุจุงุช</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8"
                d="M3 3h2l.4 2M7 13h10l3-8H6.4M7 13L5.4 5M7 13l-2 7m12-7l2 7m-8-4h4" />
        </svg>
        <span id="cart-count"
              class="hidden absolute -top-2 -right-2 min-w-[20px] h-5 rounded-full bg-red-500 text-xs flex items-center justify-center px-1">
        </span>
      </a>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-3 py-6 space-y-6">

    <!-- ุงูุณูุฉ -->
    <section class="bg-white rounded-2xl shadow p-4 sm:p-6">
      <h1 class="text-2xl font-bold mb-4">ุณูุฉ ุทูุจุงุชู</h1>

      <div id="cart-empty" class="text-gray-500 text-center py-10 hidden">
        ุงูุณูุฉ ูุงุฑุบุฉ ุญุงูููุง ๐
        <div class="mt-4">
          <a href="index.html"
             class="inline-block bg-black text-white text-sm px-4 py-2 rounded-xl">
            ุนูุฏู ููุชุณูู
          </a>
        </div>
      </div>

      <div id="cart-items-container" class="space-y-4"></div>
    </section>

    <!-- ุจูุงูุงุช ุงูุนููู + ุงูุฅุฌูุงูู -->
    <section class="bg-white rounded-2xl shadow p-4 sm:p-6">
      <h2 class="text-xl font-bold mb-4">ุจูุงูุงุช ุงูุงุณุชูุงู</h2>

      <form id="order-form" class="space-y-4">
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">ุงูุงุณู ุจุงููุงูู</label>
            <input id="name" type="text" required
                   class="w-full border rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-black">
          </div>

          <div>
            <label class="block text-sm mb-1">ุฑูู ุงููุงุชู</label>
            <input id="phone" type="tel" required
                   class="w-full border rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-black">
          </div>

          <div>
            <label class="block text-sm mb-1">ุฑูู ูุงุชู 2 (ุงุฎุชูุงุฑู)</label>
            <input id="phone2" type="tel"
                   class="w-full border rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-black">
          </div>

          <div>
            <label class="block text-sm mb-1">ุงููุญุงูุธุฉ</label>
            <select id="governorate" required
                    class="w-full border rounded-xl px-3 py-2 text-sm bg-white focus:outline-none focus:ring-1 focus:ring-black">
              <option value="">ุงุฎุชุงุฑู ุงููุญุงูุธุฉ</option>
              <option>ุงููุงูุฑุฉ</option>
              <option>ุงูุฌูุฒุฉ</option>
              <option>ุงูุฅุณููุฏุฑูุฉ</option>
              <option>ุงูููููุจูุฉ</option>
              <option>ุงูุฏููููุฉ</option>
              <option>ุงูุดุฑููุฉ</option>
              <option>ุงูุบุฑุจูุฉ</option>
              <option>ุงููููููุฉ</option>
              <option>ููุฑ ุงูุดูุฎ</option>
              <option>ุฏููุงุท</option>
              <option>ุจูุฑุณุนูุฏ</option>
              <option>ุงูุฅุณูุงุนูููุฉ</option>
              <option>ุงูุณููุณ</option>
              <option>ุงูุจุญุฑ ุงูุฃุญูุฑ</option>
              <option>ุจูู ุณููู</option>
              <option>ุงููููู</option>
              <option>ุงููููุง</option>
              <option>ุฃุณููุท</option>
              <option>ุณููุงุฌ</option>
              <option>ููุง</option>
              <option>ุงูุฃูุตุฑ</option>
              <option>ุฃุณูุงู</option>
              <option>ูุฑุณู ูุทุฑูุญ</option>
              <option>ุดูุงู ุณููุงุก</option>
              <option>ุฌููุจ ุณููุงุก</option>
              <option>ุดุฑู ุงูุดูุฎ</option>
              <option>ุงูุบุฑุฏูุฉ</option>
              <option>ุงููุงุฏู ุงูุฌุฏูุฏ</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-sm mb-1">ุงูุนููุงู ุจุงูุชูุตูู</label>
          <textarea id="address" required rows="2"
                    class="w-full border rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-black"></textarea>
        </div>

        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">ุงููุฒู (ุงุฎุชูุงุฑู)</label>
            <input id="weight" type="text"
                   class="w-full border rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-black">
          </div>
          <div>
            <label class="block text-sm mb-1">ุงูุทูู (ุงุฎุชูุงุฑู)</label>
            <input id="height" type="text"
                   class="w-full border rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-black">
          </div>
        </div>

        <div>
          <label class="block text-sm mb-1">ููุงุญุธุงุช (ุงุฎุชูุงุฑู)</label>
          <textarea id="notes" rows="2"
                    class="w-full border rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-black"></textarea>
        </div>

        <!-- ููุฏ ุงูุฎุตู -->
        <div class="bg-gray-50 border rounded-xl px-3 py-2 text-sm flex items-center justify-between gap-3">
          <div>
            <div class="font-semibold">ุฎุตู 10ูช ูุฃูู ุฃูุฑุฏุฑ ๐</div>
            <div class="text-xs text-gray-600">ููุฏ ุงูุฎุตู: <span class="font-mono">TEFA4434</span></div>
          </div>
          <label class="flex items-center gap-2 text-xs">
            <input id="use-coupon" type="checkbox" class="w-4 h-4">
            <span>ุชุทุจูู ุงูุฎุตู</span>
          </label>
        </div>

        <!-- ููุฎุต ุงูุฃุณุนุงุฑ -->
        <div class="bg-gray-50 border rounded-2xl px-4 py-3 text-sm space-y-1">
          <div class="flex justify-between">
            <span>ุฅุฌูุงูู ุงูููุชุฌุงุช</span>
            <span id="items-total">0 ุฌ</span>
          </div>
          <div class="flex justify-between">
            <span>ุงูุดุญู</span>
            <span id="shipping-total">0 ุฌ</span>
          </div>
          <div class="flex justify-between text-green-700">
            <span>ูููุฉ ุงูุฎุตู</span>
            <span id="discount-amount">0 ุฌ</span>
          </div>
          <hr class="my-1">
          <div class="flex justify-between font-bold text-lg">
            <span>ุงูุฅุฌูุงูู ุงูููุงุฆู</span>
            <span id="grand-total">0 ุฌ</span>
          </div>
        </div>

        <div id="message" class="hidden text-sm mt-1"></div>

        <div class="flex flex-col sm:flex-row gap-3 mt-3">
          <button type="submit"
                  class="flex-1 bg-black text-white py-2 rounded-xl text-sm font-semibold">
            ุชุฃููุฏ ุงูุทูุจ
          </button>
          <a href="index.html"
             class="flex-1 border border-gray-300 text-center py-2 rounded-xl text-sm">
            ูุชุงุจุนุฉ ุงูุชุณูู
          </a>
        </div>
      </form>
    </section>
  </main>

  <script>
    // ููุณ ุงูููุจ ููู ุจุชุงุน Google Apps Script
    const SHEET_WEBHOOK_URL =
      "https://script.google.com/macros/s/AKfycbxDCEny0w1V8EVpFix56-7v_e930qLEWqz1aXKt5HOaDafo9NJJn8-k-RvGfjbzg-AN/exec";

    // ====== ุงูุชุนุงูู ูุน ุงูุณูุฉ ูู LocalStorage ======
    function getCartItems() {
      let raw = localStorage.getItem("cartItems");
      if (!raw) raw = localStorage.getItem("cart"); // ุนูุดุงู ุชูุงูู ูุน ุฃู ุงุณู ูุฏูู
      if (!raw) return [];
      try {
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch (e) {
        return [];
      }
    }

    function saveCartItems(items) {
      const raw = JSON.stringify(items);
      localStorage.setItem("cartItems", raw);
      localStorage.setItem("cart", raw); // ูุญูุธ ูู ุงูุงุชููู ุนูุดุงู ูู ุงูุตูุญุงุช ุชุดุชุบู
    }

    function updateCartBadge() {
      const items = getCartItems();
      const count = items.reduce((sum, item) => sum + (item.quantity || 1), 0);
      const badge = document.getElementById("cart-count");
      if (!badge) return;
      if (count > 0) {
        badge.textContent = count;
        badge.classList.remove("hidden");
      } else {
        badge.textContent = "";
        badge.classList.add("hidden");
      }
    }

    // ====== ุนุฑุถ ุงูุณูุฉ ======
    function renderCart() {
      const items = getCartItems();
      const container = document.getElementById("cart-items-container");
      const emptyBox = document.getElementById("cart-empty");
      container.innerHTML = "";

      if (!items.length) {
        emptyBox.classList.remove("hidden");
        calculateTotals(); // ุตูุฑ ุงููู
        return;
      }
      emptyBox.classList.add("hidden");

      items.forEach((item, index) => {
        const li = document.createElement("div");
        li.className =
          "flex flex-col sm:flex-row items-center justify-between gap-3 border rounded-xl px-3 py-2";

        const colorDot = item.colorHex
          ? `<span class="inline-block w-4 h-4 rounded-full border border-gray-300"
                      style="background:${item.colorHex}"></span>`
          : "";

        li.innerHTML = `
          <div class="flex items-center gap-3 flex-1">
            ${colorDot}
            <div>
              <div class="font-semibold text-sm">${item.name || "ููุชุฌ"}</div>
              <div class="text-xs text-gray-500">
                ุงูููู: ${item.colorName || "-"} โ ุณุนุฑ ุงููุทุนุฉ: ${item.price || 0} ุฌ
              </div>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <div class="flex items-center border rounded-full overflow-hidden">
              <button type="button"
                      class="w-8 h-8 text-lg leading-none"
                      data-action="dec" data-index="${index}">โ</button>
              <span class="w-8 text-center text-sm"
                    id="qty-${index}">${item.quantity || 1}</span>
              <button type="button"
                      class="w-8 h-8 text-lg leading-none"
                      data-action="inc" data-index="${index}">+</button>
            </div>
            <div class="text-sm font-semibold min-w-[70px] text-center">
              <span id="item-total-${index}"></span> ุฌ
            </div>
            <button type="button"
                    class="text-xs text-red-500 border border-red-300 rounded-full px-2 py-1"
                    data-action="remove" data-index="${index}">
              ุญุฐู
            </button>
          </div>
        `;

        container.appendChild(li);
      });

      // ุฃุญุฏุงุซ ุงูุฃุฒุฑุงุฑ (ุฒูุงุฏุฉ/ููุตุงู/ุญุฐู)
      container.addEventListener("click", function (e) {
        const btn = e.target;
        const action = btn.getAttribute("data-action");
        if (!action) return;
        const index = parseInt(btn.getAttribute("data-index"), 10);
        const items = getCartItems();
        if (!items[index]) return;

        if (action === "inc") {
          items[index].quantity = (items[index].quantity || 1) + 1;
        } else if (action === "dec") {
          items[index].quantity = (items[index].quantity || 1) - 1;
          if (items[index].quantity <= 0) {
            items.splice(index, 1);
          }
        } else if (action === "remove") {
          items.splice(index, 1);
        }

        saveCartItems(items);
        updateCartBadge();
        renderCart();
        calculateTotals();
      });

      // ุฃูู ูุฑุฉ ูุถุจุท ุงูุฅุฌูุงููุงุช
      updateItemTotals();
      calculateTotals();
    }

    function updateItemTotals() {
      const items = getCartItems();
      items.forEach((item, index) => {
        const span = document.getElementById(`item-total-${index}`);
        const qty = item.quantity || 1;
        const price = item.price || 0;
        if (span) span.textContent = qty * price;
      });
    }

    // ====== ุญุณุงุจ ุงูุดุญู ูุงูุฎุตู ูุงูุฅุฌูุงูู ======
    function getShippingByGovernorate(gov) {
      if (!gov) return 0;
      const g = gov.trim();

      const cairo = ["ุงููุงูุฑุฉ", "ุงููุงูุฑู", "Cairo"];
      const giza = ["ุงูุฌูุฒุฉ", "ุงูุฌูุฒู", "Giza"];

      const highShipping = [
        "ุดุฑู ุงูุดูุฎ",
        "ุงูุบุฑุฏูุฉ",
        "ูุฑุณู ูุทุฑูุญ",
        "ูุฑุณู ูุทุฑูุญ",
        "ุดูุงู ุณููุงุก",
        "ุฌููุจ ุณููุงุก",
        "ุงููุงุฏู ุงูุฌุฏูุฏ",
        "ุงููุงุฏู ุงูุฌุฏูุฏ"
      ];

      if (cairo.includes(g) || giza.includes(g)) return 60;
      if (highShipping.includes(g)) return 120;
      return 70; // ุจุงูู ุงููุญุงูุธุงุช
    }

    function calculateTotals() {
      const items = getCartItems();
      const itemsTotal = items.reduce(
        (sum, item) => sum + (item.price || 0) * (item.quantity || 1),
        0
      );

      const gov = document.getElementById("governorate").value;
      const shipping = getShippingByGovernorate(gov);

      const useCoupon = document.getElementById("use-coupon").checked;
      let discount = 0;
      if (useCoupon && itemsTotal > 0) {
        // ุฎุตู 10ูช
        discount = Math.round(itemsTotal * 0.1);
      }

      const grand = itemsTotal + shipping - discount;

      document.getElementById("items-total").textContent = itemsTotal + " ุฌ";
      document.getElementById("shipping-total").textContent = shipping + " ุฌ";
      document.getElementById("discount-amount").textContent = discount + " ุฌ";
      document.getElementById("grand-total").textContent = grand + " ุฌ";
    }

    // ====== ุฅุฑุณุงู ุงูุทูุจ ุฅูู Google Sheet ======
    async function submitOrder(e) {
      e.preventDefault();
      const items = getCartItems();
      const msg = document.getElementById("message");

      if (!items.length) {
        msg.textContent = "ุงูุณูุฉ ูุงุฑุบุฉุ ุฃุถููู ููุชุฌ ุฃููุงู.";
        msg.className = "mt-2 text-sm text-red-600";
        msg.classList.remove("hidden");
        return;
      }

      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const phone2 = document.getElementById("phone2").value.trim();
      const governorate = document.getElementById("governorate").value.trim();
      const address = document.getElementById("address").value.trim();
      const notes = document.getElementById("notes").value.trim();
      const weight = document.getElementById("weight").value.trim();
      const height = document.getElementById("height").value.trim();
      const useCoupon = document.getElementById("use-coupon").checked;

      if (!name || !phone || !governorate || !address) {
        msg.textContent = "ูู ูุถูู ุงููุฆู ุจูุงูุงุช ุงูุงุณุชูุงู ุงูุฃุณุงุณูุฉ.";
        msg.className = "mt-2 text-sm text-red-600";
        msg.classList.remove("hidden");
        return;
      }

      const itemsTotal = items.reduce(
        (sum, item) => sum + (item.price || 0) * (item.quantity || 1),
        0
      );
      const shipping = getShippingByGovernorate(governorate);
      let discount = 0;
      if (useCoupon && itemsTotal > 0) {
        discount = Math.round(itemsTotal * 0.1);
      }
      const grandTotal = itemsTotal + shipping - discount;

      const productsText = items
        .map(
          (item) =>
            `${item.name || "ููุชุฌ"} - ููู: ${item.colorName || "-"} - ูููุฉ: ${
              item.quantity || 1
            } - ุณุนุฑ: ${item.price || 0}`
        )
        .join(" | ");

      const payload = {
        name,
        phone,
        phone2,
        governorate,
        address,
        notes,
        weight,
        height,
        products: productsText,
        total: grandTotal
      };

      try {
        msg.textContent = "ุฌุงุฑู ุฅุฑุณุงู ุงูุทูุจ...";
        msg.className = "mt-2 text-sm text-gray-600";
        msg.classList.remove("hidden");

        await fetch(SHEET_WEBHOOK_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        // ุงุนุชุจุฑูุง ุงูุทูุจ ูุฌุญ
        msg.textContent = "ุชู ุชุณุฌูู ุทูุจู ุจูุฌุงุญ โ ุณูุชู ุงูุชูุงุตู ูุนู ููุชุฃููุฏ.";
        msg.className = "mt-2 text-sm text-green-600";
        msg.classList.remove("hidden");

        // ุญูุธ ุฃู ุงูููุฏ ุงุณุชุฎุฏู (ุนูู ูุณุชูู ุงูุฌูุงุฒ)
        if (useCoupon) {
          localStorage.setItem("coupon_TEFA4434_used", "true");
        }

        // ุชูุฑูุบ ุงูุณูุฉ
        saveCartItems([]);
        updateCartBadge();
        renderCart();
        calculateTotals();

        // ูููู ุชุฑุฌุนู ููุตูุญุฉ ุงูุฑุฆูุณูุฉ ุจุนุฏ ุซูุงูู ูู ุญุงุจุฉ
        // setTimeout(() => window.location.href = "index.html", 2500);

      } catch (err) {
        msg.textContent =
          "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุทูุจุ ุฌุฑูุจู ูุฑุฉ ุชุงููุฉ ุฃู ุชูุงุตูู ุนู ุทุฑูู ูุงุชุณุงุจ.";
        msg.className = "mt-2 text-sm text-red-600";
        msg.classList.remove("hidden");
      }
    }

    // ====== ุชุฌููุฒ ุงูุตูุญุฉ ======
    document.addEventListener("DOMContentLoaded", () => {
      updateCartBadge();
      renderCart();
      calculateTotals();

      document
        .getElementById("governorate")
        .addEventListener("change", calculateTotals);
      document
        .getElementById("use-coupon")
        .addEventListener("change", calculateTotals);
      document
        .getElementById("order-form")
        .addEventListener("submit", submitOrder);
    });
  </script>
</body>
</html>