<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª | TEFA STORE</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #111827;
    }
    a { text-decoration: none; color: inherit; }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #111827;
      color: #fff;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    header .back {
      font-size: 20px;
      line-height: 1;
    }
    header h1 {
      font-size: 18px;
      font-weight: 700;
    }

    main {
      flex: 1;
      padding: 16px;
      max-width: 720px;
      margin: 0 auto;
    }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(15,23,42,0.06);
      margin-bottom: 16px;
    }

    .cart-item {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }
    .cart-item:last-child { margin-bottom: 0; }

    .cart-item img {
      width: 70px;
      height: 90px;
      object-fit: cover;
      border-radius: 10px;
    }
    .cart-item-info {
      flex: 1;
    }
    .cart-item-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .cart-item-color,
    .cart-item-qty {
      font-size: 12px;
      color: #4b5563;
    }
    .cart-item-price {
      font-size: 13px;
      font-weight: 600;
      margin-top: 4px;
    }
    .cart-item-remove {
      border: none;
      background: #fee2e2;
      color: #b91c1c;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
    }

    .empty {
      text-align: center;
      font-size: 14px;
      color: #6b7280;
      padding: 24px 12px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 6px;
    }
    .summary-row.total {
      font-weight: 800;
      font-size: 16px;
      margin-top: 8px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #ef4444;
      color: #fff;
      font-size: 11px;
      padding: 0 5px;
      margin-right: 4px;
    }

    .field {
      margin-bottom: 12px;
    }
    .field label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .field input,
    .field select,
    .field textarea {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 10px 14px;
      font-size: 13px;
      outline: none;
      background: #f9fafb;
    }
    .field textarea {
      border-radius: 12px;
      min-height: 70px;
      resize: vertical;
    }

    .hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    .btn-primary {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 14px;
      background: #111827;
      color: #fff;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 8px;
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: wait;
    }

    footer {
      padding: 12px 16px 16px;
      font-size: 11px;
      color: #6b7280;
      text-align: center;
    }

    @media (min-width: 768px) {
      header, main, footer {
        max-width: 720px;
        margin-inline: auto;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <a href="index.html" class="back">â†</a>
    <h1>Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
  </header>

  <main>
    <!-- ÙƒØ§Ø±Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <section class="card" id="cartCard">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div style="font-size:14px;font-weight:700;">Ù…Ù†ØªØ¬Ø§ØªÙƒ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</div>
        <div id="cartBadgeWrapper" style="font-size:12px;color:#6b7280;">
          <span>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹:</span>
          <span class="badge" id="cartCount">0</span>
        </div>
      </div>
      <div id="cartItems"></div>
      <div id="emptyCartMsg" class="empty" style="display:none;">
        Ù„Ø³Ù‡ Ù…Ø§ Ø§Ø®ØªØ±ØªÙŠØ´ Ø£ÙŠ Ù…Ù†ØªØ¬ ğŸ›’<br>Ø§Ø±Ø¬Ø¹ÙŠ Ø§Ø®ØªØ§Ø±ÙŠ Ù…ÙˆØ¯ÙŠÙ„ ÙˆØ§Ø¶ØºØ·ÙŠ "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©".
      </div>
    </section>

    <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± -->
    <section class="card">
      <div class="summary-row">
        <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
        <span id="subtotalValue">0 Ø¬</span>
      </div>
      <div class="summary-row">
        <span>Ø§Ù„Ø´Ø­Ù†</span>
        <span id="shippingValue">0 Ø¬</span>
      </div>
      <div class="summary-row total">
        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span>
        <span id="totalValue">0 Ø¬</span>
      </div>
      <div class="hint" style="margin-top:8px;">
        Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© ÙˆØ§Ù„Ø¬ÙŠØ²Ø© 60 Ø¬ â€“ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª 70 Ø¬ Ù…Ø§ Ø¹Ø¯Ø§ Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ® / Ø§Ù„ØºØ±Ø¯Ù‚Ø© / Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­ / Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡ / Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡ / Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ 120 Ø¬.
      </div>
    </section>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
    <section class="card">
      <form id="orderForm">
        <div class="field">
          <label for="name">Ø§Ù„Ø§Ø³Ù… Ø«Ù„Ø§Ø«ÙŠ *</label>
          <input id="name" type="text" required placeholder="Ù…Ø«Ø§Ù„: Ù…Ù†Ø§Ù„ Ø£Ø­Ù…Ø¯" />
        </div>

        <div class="field">
          <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ *</label>
          <input id="phone" type="tel" required placeholder="ÙŠÙØ¶Ù„ Ø±Ù‚Ù… Ø¹Ù„ÙŠÙ‡ ÙˆØ§ØªØ³Ø§Ø¨" />
        </div>

        <div class="field">
          <label for="phone2">Ø±Ù‚Ù… Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¨Ø¯ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="phone2" type="tel" placeholder="Ø±Ù‚Ù… Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªØ£ÙƒÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
        </div>

        <div class="field">
          <label for="governorate">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© *</label>
          <select id="governorate" required>
            <option value="">Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
            <option value="Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©">Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option>
            <option value="Ø§Ù„Ø¬ÙŠØ²Ø©">Ø§Ù„Ø¬ÙŠØ²Ø©</option>
            <option value="Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©">Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©</option>
            <option value="Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©">Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©</option>
            <option value="Ø§Ù„Ø´Ø±Ù‚ÙŠØ©">Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option>
            <option value="Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©">Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©</option>
            <option value="Ø§Ù„ØºØ±Ø¨ÙŠØ©">Ø§Ù„ØºØ±Ø¨ÙŠØ©</option>
            <option value="Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©">Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©</option>
            <option value="Ø§Ù„Ø¨Ø­ÙŠØ±Ø©">Ø§Ù„Ø¨Ø­ÙŠØ±Ø©</option>
            <option value="ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®">ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</option>
            <option value="Ø¯Ù…ÙŠØ§Ø·">Ø¯Ù…ÙŠØ§Ø·</option>
            <option value="Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯">Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯</option>
            <option value="Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©">Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©</option>
            <option value="Ø§Ù„Ø³ÙˆÙŠØ³">Ø§Ù„Ø³ÙˆÙŠØ³</option>
            <option value="Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ">Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ</option>
            <option value="Ø§Ù„ÙÙŠÙˆÙ…">Ø§Ù„ÙÙŠÙˆÙ…</option>
            <option value="Ø§Ù„Ù…Ù†ÙŠØ§">Ø§Ù„Ù…Ù†ÙŠØ§</option>
            <option value="Ø£Ø³ÙŠÙˆØ·">Ø£Ø³ÙŠÙˆØ·</option>
            <option value="Ø³ÙˆÙ‡Ø§Ø¬">Ø³ÙˆÙ‡Ø§Ø¬</option>
            <option value="Ù‚Ù†Ø§">Ù‚Ù†Ø§</option>
            <option value="Ø§Ù„Ø£Ù‚ØµØ±">Ø§Ù„Ø£Ù‚ØµØ±</option>
            <option value="Ø£Ø³ÙˆØ§Ù†">Ø£Ø³ÙˆØ§Ù†</option>
            <option value="Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±">Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±</option>
            <option value="Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯">Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯</option>
            <option value="Ù…Ø·Ø±ÙˆØ­">Ù…Ø·Ø±ÙˆØ­</option>
            <option value="Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­">Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­</option>
            <option value="Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡">Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡</option>
            <option value="Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡">Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡</option>
            <option value="Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®">Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®</option>
            <option value="Ø§Ù„ØºØ±Ø¯Ù‚Ø©">Ø§Ù„ØºØ±Ø¯Ù‚Ø©</option>
          </select>
        </div>

        <div class="field">
          <label for="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ *</label>
          <textarea id="address" required placeholder="Ø§Ù„Ø´Ø§Ø±Ø¹ â€“ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ù…ÙŠØ²Ø© â€“ Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØª/Ø§Ù„Ø¨Ø±Ø¬ â€“ Ø±Ù‚Ù… Ø§Ù„Ø´Ù‚Ø©"></textarea>
        </div>

        <div class="field">
          <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="notes" placeholder="Ù…Ø«Ø§Ù„: Ù…Ù‚Ø§Ø³ ÙˆØ§Ø³Ø¹ Ø´ÙˆÙŠØ©ØŒ ÙŠÙØ¶Ù„ Ø§ØªØµØ§Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø´Ø­Ù†"></textarea>
        </div>

        <div class="field">
          <label for="size">Ø§Ù„Ø·ÙˆÙ„ Ø£Ùˆ Ø§Ù„ÙˆØ²Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="size" type="text" placeholder="Ù…Ø«Ø§Ù„: 165 Ø³Ù… / 80 Ùƒ" />
          <div class="hint">Ø¹Ø´Ø§Ù† Ù†Ø³Ø§Ø¹Ø¯Ùƒ Ù†Ø®ØªØ§Ø± Ø£Ù†Ø³Ø¨ Ù…Ù‚Ø§Ø³ Ù„ÙŠÙƒÙŠ â¤ï¸</div>
        </div>

        <button type="submit" class="btn-primary" id="submitBtn">
          Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ...
        </button>
      </form>
    </section>
  </main>

  <footer>
    Ù„Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø± Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ØªÙ‚Ø¯Ø± ØªÙƒÙ„Ù…Ù†Ø§ ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù„Ù‰: <strong>01029942139</strong>
  </footer>
</div>

<script>
  // ========== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ==========
  const SHEET_URL = "https://script.google.com/macros/s/AKfycbwPgm3Ez315GP5_E4SyM-NOjId3Whah4tdrXCRCHF1wYlk_CVwEgs4kd8WHCpJ50ggpiw/exec";

  // Ù†Ø­Ø§ÙˆÙ„ Ù†Ù‚Ø±Ø£ Ø§Ù„Ø³Ù„Ø© Ù…Ù† Ø£ÙƒØªØ± Ù…Ù† Ù…ÙØªØ§Ø­ Ø§Ø­ØªÙŠØ§Ø·ÙŠÙ‹Ø§
  const CART_KEYS = ["tefaCart", "tefa-cart", "tefa_cart", "tefa_cart_v1"];

  let currentCartKey = CART_KEYS[0];
  let cartItems = [];

  const subtotalEl = document.getElementById("subtotalValue");
  const shippingEl = document.getElementById("shippingValue");
  const totalEl = document.getElementById("totalValue");
  const cartItemsEl = document.getElementById("cartItems");
  const emptyCartMsg = document.getElementById("emptyCartMsg");
  const cartCountEl = document.getElementById("cartCount");
  const governorateEl = document.getElementById("governorate");
  const submitBtn = document.getElementById("submitBtn");

  // Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø´Ø­Ù†
  function getShippingPrice(governorate) {
    if (!governorate) return 0;

    const special120 = [
      "Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®",
      "Ø§Ù„ØºØ±Ø¯Ù‚Ø©",
      "Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­",
      "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡",
      "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡",
      "Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯"
    ];

    if (special120.includes(governorate)) return 120;
    if (governorate === "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©" || governorate === "Ø§Ù„Ø¬ÙŠØ²Ø©") return 60;

    return 70; // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
  }

  // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ù„Ø© Ù…Ù† localStorage
  function loadCartFromStorage() {
    for (const key of CART_KEYS) {
      const raw = localStorage.getItem(key);
      if (!raw) continue;

      try {
        const data = JSON.parse(raw);
        if (Array.isArray(data)) {
          currentCartKey = key;
          return data;
        }
        if (data && Array.isArray(data.items)) {
          currentCartKey = key;
          return data.items;
        }
      } catch (e) {
        console.warn("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­:", key, e);
      }
    }
    return [];
  }

  function saveCartToStorage() {
    // Ù†Ø­ÙØ¸ ÙƒÙ€ Array Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø´Ø§Ù† Ø§Ù„Ø¨Ø³Ø§Ø·Ø©
    localStorage.setItem(currentCartKey, JSON.stringify(cartItems));
    // Ù†Ø­Ø¯Ù‘Ø« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù„ÙŠ Ø¨ØªØ³ØªØ®Ø¯Ù…Ù‡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    const totalCount = cartItems.reduce((sum, item) => sum + (item.quantity || 1), 0);
    localStorage.setItem("tefaCartCount", String(totalCount));
  }

  function renderCart() {
    cartItemsEl.innerHTML = "";

    if (!cartItems.length) {
      emptyCartMsg.style.display = "block";
      document.getElementById("cartBadgeWrapper").style.display = "none";
      subtotalEl.textContent = "0 Ø¬";
      shippingEl.textContent = "0 Ø¬";
      totalEl.textContent = "0 Ø¬";
      cartCountEl.textContent = "0";
      return;
    }

    emptyCartMsg.style.display = "none";
    document.getElementById("cartBadgeWrapper").style.display = "block";

    let subtotal = 0;
    let count = 0;

    cartItems.forEach((item, index) => {
      const price = Number(item.price || 0);
      const quantity = Number(item.quantity || 1);
      const itemTotal = price * quantity;
      subtotal += itemTotal;
      count += quantity;

      const wrapper = document.createElement("div");
      wrapper.className = "cart-item";

      const img = document.createElement("img");
      img.src = item.image || "rozalin-main.jpg";
      img.alt = item.name || "Ø§Ù„Ù…Ù†ØªØ¬";

      const info = document.createElement("div");
      info.className = "cart-item-info";

      const title = document.createElement("div");
      title.className = "cart-item-title";
      title.textContent = item.name || "Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";

      const color = document.createElement("div");
      color.className = "cart-item-color";
      if (item.colorName) {
        color.textContent = "Ø§Ù„Ù„ÙˆÙ†: " + item.colorName;
      } else {
        color.textContent = "";
      }

      const qty = document.createElement("div");
      qty.className = "cart-item-qty";
      qty.textContent = "Ø§Ù„ÙƒÙ…ÙŠØ©: " + quantity;

      const priceEl = document.createElement("div");
      priceEl.className = "cart-item-price";
      priceEl.textContent = itemTotal.toLocaleString("ar-EG") + " Ø¬";

      info.appendChild(title);
      if (color.textContent) info.appendChild(color);
      info.appendChild(qty);
      info.appendChild(priceEl);

      const removeBtn = document.createElement("button");
      removeBtn.className = "cart-item-remove";
      removeBtn.textContent = "Ø­Ø°Ù";
      removeBtn.addEventListener("click", () => {
        removeItem(index);
      });

      wrapper.appendChild(img);
      wrapper.appendChild(info);
      wrapper.appendChild(removeBtn);

      cartItemsEl.appendChild(wrapper);
    });

    cartCountEl.textContent = String(count);
    subtotalEl.textContent = subtotal.toLocaleString("ar-EG") + " Ø¬";

    const shipping = getShippingPrice(governorateEl.value);
    shippingEl.textContent = shipping.toLocaleString("ar-EG") + " Ø¬";
    const total = subtotal + shipping;
    totalEl.textContent = total.toLocaleString("ar-EG") + " Ø¬";
  }

  function removeItem(index) {
    cartItems.splice(index, 1);
    saveCartToStorage();
    renderCart();
  }

  governorateEl.addEventListener("change", renderCart);

  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Google Sheet
  async function sendOrderToSheet(payload) {
    const response = await fetch(SHEET_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!response.ok) {
      throw new Error("Network response was not ok");
    }

    const data = await response.json().catch(() => ({}));
    if (!data || data.result !== "success") {
      throw new Error("Google Sheet returned error");
    }
    return data;
  }

  // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ ØµÙŠØºØ© Ù†Øµ ÙˆØ§Ø¶Ø­
  function buildProductsText() {
    if (!cartItems.length) return "";

    return cartItems
      .map((item, idx) => {
        const price = Number(item.price || 0);
        const quantity = Number(item.quantity || 1);
        const itemTotal = price * quantity;
        const parts = [];
        parts.push(`${idx + 1} - ${item.name || "Ù…Ù†ØªØ¬"}`);
        if (item.colorName) parts.push(`Ø§Ù„Ù„ÙˆÙ†: ${item.colorName}`);
        parts.push(`Ø§Ù„ÙƒÙ…ÙŠØ©: ${quantity}`);
        parts.push(`Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø©: ${price} Ø¬`);
        parts.push(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù„ÙˆÙ†: ${itemTotal} Ø¬`);
        return parts.join(" | ");
      })
      .join("\n");
  }

  document.getElementById("orderForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!cartItems.length) {
      alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ©ØŒ Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ù†ØªØ¬ Ø§Ù„Ø£ÙˆÙ„ ğŸŒ¸");
      return;
    }

    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const phone2 = document.getElementById("phone2").value.trim();
    const governorate = governorateEl.value;
    const address = document.getElementById("address").value.trim();
    const notes = document.getElementById("notes").value.trim();
    const size = document.getElementById("size").value.trim();

    if (!name || !phone || !governorate || !address) {
      alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø¥ÙƒÙ…Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ØŒ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©ØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†).");
      return;
    }

    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
    const subtotal = cartItems.reduce(
      (sum, item) => sum + Number(item.price || 0) * Number(item.quantity || 1),
      0
    );
    const shipping = getShippingPrice(governorate);
    const total = subtotal + shipping;

    const productsText = buildProductsText();

    const payload = {
      name,
      phone,
      phone2,
      governorate,
      address,
      notes,
      size,
      subtotal,
      shipping,
      total,
      products: productsText,
    };

    submitBtn.disabled = true;
    submitBtn.textContent = "Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ...";

    try {
      await sendOrderToSheet(payload);

      alert("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ ğŸ’— Ù‡Ù†ÙƒÙ„Ù…Ùƒ Ù„ØªØ£ÙƒÙŠØ¯Ù‡ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª.");

      // Ù†ÙØ¶ÙŠ Ø§Ù„Ø³Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
      cartItems = [];
      saveCartToStorage();
      renderCart();

      // Ù…Ù…ÙƒÙ† ØªØ±Ø¬Ø¹ÙŠ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      window.location.href = "index.html";
    } catch (err) {
      console.error(err);
      alert(
        "ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Google Sheet. Ù„Ùˆ Ø³Ù…Ø­ØªÙŠ ÙƒÙ„Ù…ÙŠÙ†Ø§ ÙˆØ§ØªØ³Ø§Ø¨ Ù„ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ."
      );
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨";
    }
  });

  // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  (function init() {
    cartItems = loadCartFromStorage();
    // Ø£ÙˆÙ„ Ù…Ø±Ø© Ù†Ø®Ù„ÙŠ Ø²Ø±Ø§Ø± Ù…ÙƒØªÙˆØ¨ Ø¹Ù„ÙŠÙ‡ "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨"
    submitBtn.textContent = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨";
    renderCart();
  })();
</script>
</body>
</html>