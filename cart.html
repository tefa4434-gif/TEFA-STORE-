<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª | TEFA STORE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#f4f4f4;
      margin:0;
      padding:0;
    }
    header {
      background:#111;
      color:#fff;
      padding:10px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      position:sticky;
      top:0;
      z-index:10;
    }
    header .logo {
      font-weight:700;
      font-size:18px;
    }
    .cart-icon {
      position:relative;
      font-size:22px;
    }
    .cart-badge {
      position:absolute;
      top:-6px;
      left:-8px;
      background:#ff4757;
      color:#fff;
      border-radius:999px;
      padding:0 6px;
      font-size:11px;
      min-width:18px;
      text-align:center;
    }
    main { padding:16px; max-width:800px; margin:0 auto; }

    .card {
      background:#fff;
      border-radius:16px;
      padding:16px;
      margin-bottom:16px;
      box-shadow:0 4px 10px rgba(0,0,0,.05);
    }

    .cart-item {
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid #eee;
      padding:8px 0;
    }
    .cart-item:last-child { border-bottom:none; }
    .cart-item-info {
      flex:1;
      margin-inline-end:8px;
    }
    .cart-item-title { font-weight:600; font-size:15px; }
    .cart-item-meta { font-size:13px; color:#555; margin-top:4px; }
    .qty-controls {
      display:flex;
      align-items:center;
      gap:6px;
    }
    .qty-btn {
      width:26px;
      height:26px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#fafafa;
      font-size:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .qty-value { min-width:18px; text-align:center; }

    .remove-btn {
      border:none;
      background:transparent;
      color:#e74c3c;
      font-size:18px;
      cursor:pointer;
    }

    .summary-row {
      display:flex;
      justify-content:space-between;
      margin:4px 0;
      font-size:14px;
    }
    .summary-row.total {
      font-weight:700;
      font-size:16px;
      margin-top:8px;
      border-top:1px dashed #ddd;
      padding-top:6px;
    }
    .summary-row.discount {
      color:#27ae60;
    }

    label {
      display:block;
      font-size:13px;
      margin-bottom:4px;
    }
    input, select, textarea {
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #ddd;
      font-family:inherit;
      font-size:14px;
      box-sizing:border-box;
      margin-bottom:10px;
    }
    textarea { resize:vertical; min-height:70px; }

    .btn-primary {
      width:100%;
      padding:12px;
      border-radius:999px;
      border:none;
      background:#000;
      color:#fff;
      font-size:16px;
      font-weight:600;
      cursor:pointer;
      margin-top:4px;
    }
    .btn-primary:disabled {
      opacity:.6;
      cursor:not-allowed;
    }

    .empty {
      text-align:center;
      color:#666;
      padding:24px 0;
      font-size:15px;
    }

    .discount-note {
      font-size:13px;
      color:#e67e22;
      margin-top:-6px;
      margin-bottom:10px;
    }
  </style>
</head>
<body>
<header>
  <div class="logo">TEFA STORE</div>
  <div class="cart-icon">
    <i class="fa-solid fa-cart-shopping"></i>
    <span class="cart-badge" id="headerCartCount">0</span>
  </div>
</header>

<main>
  <!-- Ø³Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
  <section class="card">
    <h3 style="margin-top:0;">Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
    <div id="cartItems"></div>
    <div id="cartEmpty" class="empty" style="display:none;">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© ğŸ‘€</div>
  </section>

  <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø¹Ø± -->
  <section class="card">
    <h3 style="margin-top:0;">Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h3>
    <div class="summary-row">
      <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
      <span id="itemsTotal">0 Ø¬</span>
    </div>
    <div class="summary-row">
      <span>Ø§Ù„Ø´Ø­Ù†</span>
      <span id="shippingCost">0 Ø¬</span>
    </div>
    <div class="summary-row discount" id="discountRow" style="display:none;">
      <span>Ø®ØµÙ… ÙƒÙˆØ¯ TEFA4434</span>
      <span id="discountValue">-0 Ø¬</span>
    </div>
    <div class="summary-row total">
      <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</span>
      <span id="grandTotal">0 Ø¬</span>
    </div>
  </section>

  <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
  <section class="card">
    <h3 style="margin-top:0;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø­Ù†</h3>
    <form id="orderForm">
      <label>Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„ *</label>
      <input type="text" id="name" required />

      <label>Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† *</label>
      <input type="tel" id="phone" required />

      <label>Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† 2 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input type="tel" id="phone2" />

      <label>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© *</label>
      <select id="governorate" required>
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
        <option>Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option>
        <option>Ø§Ù„Ø¬ÙŠØ²Ø©</option>
        <option>Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©</option>
        <option>Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©</option>
        <option>Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option>
        <option>Ø§Ù„ØºØ±Ø¨ÙŠØ©</option>
        <option>Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©</option>
        <option>Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©</option>
        <option>ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</option>
        <option>Ø§Ù„Ø¨Ø­ÙŠØ±Ø©</option>
        <option>Ø¯Ù…ÙŠØ§Ø·</option>
        <option>Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯</option>
        <option>Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©</option>
        <option>Ø§Ù„Ø³ÙˆÙŠØ³</option>
        <option>Ø§Ù„ÙÙŠÙˆÙ…</option>
        <option>Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ</option>
        <option>Ø§Ù„Ù…Ù†ÙŠØ§</option>
        <option>Ø£Ø³ÙŠÙˆØ·</option>
        <option>Ø³ÙˆÙ‡Ø§Ø¬</option>
        <option>Ù‚Ù†Ø§</option>
        <option>Ø§Ù„Ø£Ù‚ØµØ±</option>
        <option>Ø£Ø³ÙˆØ§Ù†</option>
        <option>Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±</option>
        <option>Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯</option>
        <option>Ù…Ø·Ø±ÙˆØ­</option>
        <option>Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡</option>
        <option>Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡</option>
        <option>Ù…Ø±Ø³ÙŠ Ù…Ø·Ø±ÙˆØ­</option>
        <option>Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®</option>
        <option>Ø§Ù„ØºØ±Ø¯Ù‚Ø©</option>
      </select>

      <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ *</label>
      <textarea id="address" required></textarea>

      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <textarea id="notes"></textarea>

      <label>Ø§Ù„ÙˆØ²Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input type="text" id="weight" placeholder="Ù…Ø«Ø§Ù„ 75 Ùƒ" />

      <label>Ø§Ù„Ø·ÙˆÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input type="text" id="height" placeholder="Ù…Ø«Ø§Ù„ 165 Ø³Ù…" />

      <label>ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… (10Ùª Ù„Ø£ÙˆÙ„ Ø£ÙˆØ±Ø¯Ø±)</label>
      <input type="text" id="coupon" placeholder="TEFA4434" />
      <div class="discount-note">Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¹Ù…Ù„ Ù„Ø£ÙˆÙ„ Ø·Ù„Ø¨ Ø¨Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙÙ‚Ø· âœ¨</div>

      <button type="submit" class="btn-primary" id="submitBtn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
    </form>
  </section>
</main>

<script>
  // Ù†ÙØ³ Ø§Ù„Ù…ÙØªØ§Ø­ ÙÙŠ index / product
  const CART_KEY = "tefa_cart";

  // Ù„ÙŠÙ†Ùƒ Google Apps Script (Ø¢Ø®Ø± Ù„ÙŠÙ†Ùƒ Ù†Ø´Ø±ØªÙ‡)
  const GOOGLE_SCRIPT_URL =
    "https://script.google.com/macros/s/AKfycbxDCEny0w1V8EVpFix56-7v_e930qLEWqz1aXKt5HOaDafo9NJJn8-k-RvGfjbzg-AN/exec";

  // governorates with 120 shipping
  const HIGH_SHIPPING = [
    "Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®",
    "Ø§Ù„ØºØ±Ø¯Ù‚Ø©",
    "Ù…Ø±Ø³ÙŠ Ù…Ø·Ø±ÙˆØ­",
    "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡",
    "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡",
    "Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯"
  ];

  let cart = [];

  function loadCart() {
    const saved = localStorage.getItem(CART_KEY);
    cart = saved ? JSON.parse(saved) : [];

    const container = document.getElementById("cartItems");
    const empty = document.getElementById("cartEmpty");
    container.innerHTML = "";

    if (!cart.length) {
      empty.style.display = "block";
      document.getElementById("submitBtn").disabled = true;
      updateHeaderCount();
      updateSummary();
      return;
    }

    document.getElementById("submitBtn").disabled = false;
    empty.style.display = "none";

    cart.forEach((item, index) => {
      const row = document.createElement("div");
      row.className = "cart-item";

      const info = document.createElement("div");
      info.className = "cart-item-info";
      info.innerHTML = `
        <div class="cart-item-title">${item.name}</div>
        <div class="cart-item-meta">
          Ø§Ù„Ù„ÙˆÙ†: ${item.colorName || "-"} â€¢ Ø§Ù„Ø³Ø¹Ø±: ${item.price} Ø¬
        </div>
      `;

      const controls = document.createElement("div");
      controls.className = "qty-controls";
      controls.innerHTML = `
        <button class="qty-btn" data-action="minus">-</button>
        <span class="qty-value">${item.quantity}</span>
        <button class="qty-btn" data-action="plus">+</button>
      `;

      controls.addEventListener("click", (e) => {
        const btn = e.target.closest(".qty-btn");
        if (!btn) return;
        if (btn.dataset.action === "plus") {
          item.quantity++;
        } else if (btn.dataset.action === "minus" && item.quantity > 1) {
          item.quantity--;
        }
        saveCart();
        loadCart();
      });

      const removeBtn = document.createElement("button");
      removeBtn.className = "remove-btn";
      removeBtn.innerHTML = "&times;";
      removeBtn.addEventListener("click", () => {
        cart.splice(index, 1);
        saveCart();
        loadCart();
      });

      row.appendChild(info);
      row.appendChild(controls);
      row.appendChild(removeBtn);
      container.appendChild(row);
    });

    updateHeaderCount();
    updateSummary();
  }

  function saveCart() {
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
  }

  function updateHeaderCount() {
    const count = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
    document.getElementById("headerCartCount").textContent = count;
  }

  function calcItemsTotal() {
    return cart.reduce(
      (sum, item) => sum + Number(item.price) * (item.quantity || 1),
      0
    );
  }

  function calcShipping(governorate) {
    if (!cart.length) return 0;
    if (governorate === "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©" || governorate === "Ø§Ù„Ø¬ÙŠØ²Ø©") return 60;
    if (HIGH_SHIPPING.includes(governorate)) return 120;
    return 70;
  }

  function updateSummary() {
    const itemsTotal = calcItemsTotal();
    const gov = document.getElementById("governorate").value;
    const shipping = calcShipping(gov);
    let discount = 0;

    const phone = document.getElementById("phone").value.trim();
    const coupon = document.getElementById("coupon").value.trim().toUpperCase();
    const discountPhones =
      JSON.parse(localStorage.getItem("discountPhones") || "[]");

    const firstOrderForPhone = phone && !discountPhones.includes(phone);

    if (coupon === "TEFA4434" && firstOrderForPhone && itemsTotal > 0) {
      discount = Math.round(itemsTotal * 0.1);
      document.getElementById("discountRow").style.display = "flex";
      document.getElementById("discountValue").textContent = `- ${discount} Ø¬`;
    } else {
      document.getElementById("discountRow").style.display = "none";
    }

    const grandTotal = itemsTotal + shipping - discount;

    document.getElementById("itemsTotal").textContent = `${itemsTotal} Ø¬`;
    document.getElementById("shippingCost").textContent = `${shipping} Ø¬`;
    document.getElementById("grandTotal").textContent = `${grandTotal} Ø¬`;
  }

  document
    .getElementById("governorate")
    .addEventListener("change", updateSummary);
  document.getElementById("phone").addEventListener("input", updateSummary);
  document.getElementById("coupon").addEventListener("input", updateSummary);

  document
    .getElementById("orderForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();
      if (!cart.length) {
        alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©.");
        return;
      }

      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const phone2 = document.getElementById("phone2").value.trim();
      const governorate = document.getElementById("governorate").value;
      const address = document.getElementById("address").value.trim();
      const notes = document.getElementById("notes").value.trim();
      const weight = document.getElementById("weight").value.trim();
      const height = document.getElementById("height").value.trim();
      const coupon = document.getElementById("coupon").value.trim().toUpperCase();

      const itemsTotal = calcItemsTotal();
      const shipping = calcShipping(governorate);

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø£Ø¹Ù„Ø§Ù‡
      let discount = 0;
      const discountPhones =
        JSON.parse(localStorage.getItem("discountPhones") || "[]");
      const firstOrderForPhone = phone && !discountPhones.includes(phone);

      if (coupon === "TEFA4434" && firstOrderForPhone && itemsTotal > 0) {
        discount = Math.round(itemsTotal * 0.1);
      }

      const total = itemsTotal + shipping - discount;

      const orderData = {
        name,
        phone,
        phone2,
        governorate,
        address,
        notes,
        weight,
        height,
        shipping,
        discount,
        total,
        products: cart
      };

      const btn = document.getElementById("submitBtn");
      btn.disabled = true;
      btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...";

      try {
        // Ù„Ø§ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† response.ok Ø¹Ø´Ø§Ù† no-cors
        await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(orderData)
        });

        // Ø­ÙØ¸ Ø£Ù† Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ø§Ø³ØªØ®Ø¯Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…
        if (coupon === "TEFA4434" && firstOrderForPhone) {
          discountPhones.push(phone);
          localStorage.setItem(
            "discountPhones",
            JSON.stringify(discountPhones)
          );
        }

        alert("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ â¤ï¸ Ù‡Ù†ÙƒÙ„Ù…Ùƒ Ù„ØªØ£ÙƒÙŠØ¯Ù‡ ÙÙŠ Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª.");
        localStorage.removeItem(CART_KEY);
        loadCart();
        // Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
        setTimeout(() => {
          window.location.href = "index.html";
        }, 2000);
      } catch (err) {
        console.error(err);
        alert(
          "ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Google Sheet. Ù„Ùˆ Ø³Ù…Ø­ØªÙŠ ÙƒÙ„Ù…ÙŠÙ†Ø§ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ Ù„ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ."
        );
        btn.disabled = false;
        btn.textContent = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨";
      }
    });

  document.addEventListener("DOMContentLoaded", () => {
    loadCart();
  });
</script>
</body>
</html>