<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>TEFA STORE | سلة الطلبات</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">

<!-- الهيدر -->
<header class="bg-gray-200 p-4 flex justify-between items-center shadow">
  <a href="index.html" class="text-sm">← رجوع للمتجر</a>
  <h1 class="font-bold text-lg">سلة الطلبات</h1>
  <span class="text-xs text-gray-500">TEFA STORE</span>
</header>

<!-- خطوة / ستيب بار -->
<section class="container mx-auto px-4 pt-3 max-w-md">
  <div class="flex items-center justify-between text-[11px] text-gray-600 mb-2">
    <div class="flex items-center gap-1">
      <span class="w-5 h-5 rounded-full bg-black text-white flex items-center justify-center text-[10px]">1</span>
      <span>السلة</span>
    </div>
    <div class="flex-1 h-[1px] bg-gray-300 mx-2"></div>
    <div class="flex items-center gap-1">
      <span class="w-5 h-5 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-[10px]">2</span>
      <span>بيانات العميل</span>
    </div>
    <div class="flex-1 h-[1px] bg-gray-200 mx-2"></div>
    <div class="flex items-center gap-1">
      <span class="w-5 h-5 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-[10px]">3</span>
      <span>تأكيد الطلب</span>
    </div>
  </div>
</section>

<!-- محتوى السلة -->
<section class="container mx-auto px-4 pb-32 max-w-md">

  <!-- كروت المنتجات في السلة -->
  <div id="cartItems" class="space-y-3 mt-2"></div>

  <!-- إجمالي السلة -->
  <div id="cartTotalBox" class="bg-white p-3 rounded-2xl shadow mt-4 hidden">
    <div class="flex items-center justify-between text-sm">
      <span class="text-gray-700">إجمالي المنتجات</span>
      <span class="font-bold"><span id="cartTotal">0</span> جنيه</span>
    </div>
    <p class="text-[11px] text-gray-500 mt-1">
      يتم إضافة تكلفة الشحن (60 للقاهرة / 70 لباقي المحافظات) في الخطوة التالية.
    </p>
  </div>

</section>

<!-- زر ثابت أسفل الشاشة -->
<div id="checkoutBar"
     class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-300 py-3 px-4 flex items-center justify-between max-w-md mx-auto hidden">
  <div>
    <p class="text-xs text-gray-500">الإجمالي المبدئي</p>
    <p class="font-bold text-lg"><span id="cartTotalBottom">0</span> جنيه</p>
  </div>
  <button id="checkoutBtn"
    class="bg-black text-white px-6 py-3 rounded-2xl text-sm font-semibold shadow">
    متابعة إدخال البيانات
  </button>
</div>

<!-- نموذج بيانات العميل -->
<section id="orderSection"
  class="hidden container mx-auto bg-white p-4 rounded-2xl shadow mt-4 max-w-md mb-24">

  <h2 class="font-bold text-lg mb-3 text-center">بيانات التوصيل</h2>

  <form id="orderForm" class="space-y-3 text-sm">

    <textarea id="orderDetails" readonly
      class="w-full border p-2 rounded bg-gray-100 text-sm h-24"></textarea>

    <input id="fullName" required placeholder="الاسم بالكامل" class="w-full border p-2 rounded">
    <input id="phone1" required placeholder="رقم الهاتف" class="w-full border p-2 rounded">
    <input id="phone2" placeholder="رقم هاتف 2 (اختياري)" class="w-full border p-2 rounded">
    <input id="address" required placeholder="العنوان بالتفصيل" class="w-full border p-2 rounded">

    <div class="flex gap-2">
      <input id="weight" placeholder="الوزن (اختياري)" class="w-1/2 border p-2 rounded">
      <input id="height" placeholder="الطول (اختياري)" class="w-1/2 border p-2 rounded">
    </div>

    <select id="governorate" required class="w-full border p-2 rounded">
      <option value="">اختر المحافظة</option>
      <option>القاهرة</option>
      <option>الجيزة</option>
      <option>الإسكندرية</option>
      <option>الدقهلية</option>
      <option>الشرقية</option>
      <option>الغربية</option>
      <option>المنوفية</option>
      <option>القليوبية</option>
      <option>سوهاج</option>
      <option>أسيوط</option>
      <option>قنا</option>
      <option>أسوان</option>
      <option>الأقصر</option>
      <option>باقي المحافظات</option>
    </select>

    <textarea id="notes" placeholder="ملاحظات (اختياري)"
      class="w-full border p-2 rounded h-16"></textarea>

    <div id="summary" class="bg-gray-100 p-3 rounded text-sm hidden">
      <div class="flex items-center justify-between mb-1">
        <span>إجمالي المنتجات</span>
        <span><span id="sumProducts"></span> جنيه</span>
      </div>
      <div class="flex items-center justify-between mb-1">
        <span>الشحن</span>
        <span><span id="sumShipping"></span> جنيه</span>
      </div>
      <div class="flex items-center justify-between font-bold border-t border-gray-300 pt-2 mt-1">
        <span>الإجمالي النهائي</span>
        <span><span id="sumTotal"></span> جنيه</span>
      </div>
    </div>

    <button class="bg-black text-white w-full py-3 rounded-2xl font-semibold">
      تأكيد الطلب
    </button>

  </form>
</section>

<script>
// تحميل السلة
let cart = [];
try {
  cart = JSON.parse(localStorage.getItem("cart") || "[]");
} catch(e) { cart = []; }

const cartItemsEl   = document.getElementById("cartItems");
const cartTotalBox  = document.getElementById("cartTotalBox");
const cartTotalEl   = document.getElementById("cartTotal");
const cartTotalBottomEl = document.getElementById("cartTotalBottom");
const checkoutBar   = document.getElementById("checkoutBar");
const checkoutBtn   = document.getElementById("checkoutBtn");

const orderSection  = document.getElementById("orderSection");
const orderForm     = document.getElementById("orderForm");
const orderDetails  = document.getElementById("orderDetails");
const fullNameEl    = document.getElementById("fullName");
const phone1El      = document.getElementById("phone1");
const phone2El      = document.getElementById("phone2");
const addressEl     = document.getElementById("address");
const weightEl      = document.getElementById("weight");
const heightEl      = document.getElementById("height");
const governorateEl = document.getElementById("governorate");
const notesEl       = document.getElementById("notes");
const summaryBox    = document.getElementById("summary");
const sumProductsEl = document.getElementById("sumProducts");
const sumShippingEl = document.getElementById("sumShipping");
const sumTotalEl    = document.getElementById("sumTotal");

let productsTotal = 0;

// عرض محتوى السلة
function renderCart(){
  cartItemsEl.innerHTML = "";
  productsTotal = 0;

  if(cart.length === 0){
    cartItemsEl.innerHTML = `
      <div class="bg-white rounded-2xl shadow p-4 mt-4 text-center">
        <p class="text-sm text-gray-700 mb-1">السلة فارغة حالياً.</p>
        <p class="text-[11px] text-gray-500 mb-3">يمكنك الرجوع للمتجر وإضافة المنتجات التي ترغبين بها.</p>
        <a href="index.html"
           class="inline-block bg-black text-white px-4 py-2 rounded-2xl text-sm">
          الرجوع للمتجر
        </a>
      </div>
    `;
    cartTotalBox.classList.add("hidden");
    checkoutBar.classList.add("hidden");
    return;
  }

  cart.forEach((item, index) => {
    const sub = item.qty * item.price;
    productsTotal += sub;

    const div = document.createElement("div");
    div.className = "bg-white p-3 rounded-2xl shadow flex justify-between items-center text-sm";
    div.innerHTML = `
      <div class="text-right">
        <p class="font-bold text-[13px] mb-1">${item.name}</p>
        <p class="text-[12px] text-gray-700 mb-1">اللون: ${item.color}</p>
        <p class="text-[12px] text-gray-700 mb-1">الكمية: ${item.qty}</p>
        <p class="text-[12px] text-gray-900 font-semibold">الإجمالي: ${sub} جنيه</p>
      </div>
      <button type="button" data-index="${index}"
        class="text-red-600 text-[11px] border border-red-200 px-2 py-1 rounded-xl">
        حذف
      </button>
    `;
    cartItemsEl.appendChild(div);
  });

  cartTotalEl.textContent = productsTotal;
  cartTotalBottomEl.textContent = productsTotal;
  cartTotalBox.classList.remove("hidden");
  checkoutBar.classList.remove("hidden");
}
renderCart();

// حذف عنصر من السلة
cartItemsEl.addEventListener("click", e => {
  if(e.target.matches("button[data-index]")){
    const i = parseInt(e.target.dataset.index);
    cart.splice(i,1);
    localStorage.setItem("cart", JSON.stringify(cart));
    renderCart();
  }
});

// زر متابعة إدخال البيانات
checkoutBtn.addEventListener("click", () => {
  if(cart.length === 0){
    alert("السلة فارغة");
    return;
  }

  let text = "";
  productsTotal = 0;

  cart.forEach((item, i) => {
    const sub = item.qty * item.price;
    productsTotal += sub;
    text += `${i+1}) ${item.name} - ${item.color} × ${item.qty} = ${sub} جنيه\n`;
  });

  orderDetails.value = text;
  sumProductsEl.textContent = productsTotal;

  updateSummary();
  orderSection.classList.remove("hidden");
  orderSection.scrollIntoView({behavior:"smooth"});
});

// تحديث ملخص السعر
function updateSummary(){
  if(productsTotal <= 0){
    summaryBox.classList.add("hidden");
    return;
  }
  let shipping = 70;
  if(governorateEl.value === "القاهرة") shipping = 60;
  sumShippingEl.textContent = shipping;
  sumTotalEl.textContent = productsTotal + shipping;
  summaryBox.classList.remove("hidden");
}
governorateEl.addEventListener("change", updateSummary);

// إرسال الطلب
orderForm.addEventListener("submit", e => {
  e.preventDefault();

  let shipping = 70;
  if(governorateEl.value === "القاهرة") shipping = 60;
  const total = productsTotal + shipping;
  const now = new Date();

  const orderData = {
    product: orderDetails.value,
    name: fullNameEl.value,
    phone1: phone1El.value,
    phone2: phone2El.value,
    address: addressEl.value,
    weight: weightEl.value,
    height: heightEl.value,
    governorate: governorateEl.value,
    notes: notesEl.value,
    shipping: shipping,
    total: total,
    time: now.toLocaleString("ar-EG"),
    timestamp: now.getTime()
  };

  const orders = JSON.parse(localStorage.getItem("orders") || "[]");
  orders.push(orderData);
  localStorage.setItem("orders", JSON.stringify(orders));

  // تنظيف السلة
  cart = [];
  localStorage.setItem("cart", JSON.stringify(cart));

  alert("✅ تم تأكيد الطلب بنجاح");
  window.location.href = "index.html";
});
</script>

</body>
</html>