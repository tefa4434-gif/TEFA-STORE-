<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TEFA STORE | Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <header class="bg-gray-900 text-white py-4 shadow">
    <div class="container mx-auto px-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="bg-white text-gray-900 font-bold px-3 py-1 rounded-full text-sm">TS</span>
        <h1 class="text-xl font-bold">TEFA STORE</h1>
      </div>

      <a href="cart.html" class="relative">
        <span class="material-icons">shopping_cart</span>
        <span id="cart-count-badge"
              class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">
          0
        </span>
      </a>
    </div>
  </header>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
  <main class="container mx-auto px-4 py-6 space-y-6">

    <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù„Ø© -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-bold mb-3">Ø³Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
      <div id="cart-items" class="space-y-3"></div>

      <div class="border-t pt-3 mt-3 text-sm">
        <div class="flex justify-between mb-1">
          <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
          <span id="subtotal">0 Ø¬</span>
        </div>
        <div class="flex justify-between mb-1">
          <span>Ø§Ù„Ø´Ø­Ù†</span>
          <span id="shipping">0 Ø¬</span>
        </div>
        <div class="flex justify-between mb-1 text-green-600">
          <span>Ø§Ù„Ø®ØµÙ… (Ù„Ùˆ ÙÙŠÙ‡ ÙƒÙˆØ¯)</span>
          <span id="discount">0 Ø¬</span>
        </div>
        <div class="flex justify-between font-bold text-lg mt-2">
          <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</span>
          <span id="total">0 Ø¬</span>
        </div>
      </div>
    </section>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-bold mb-4">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</h2>

      <form id="order-form" class="space-y-4">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-1 text-sm font-medium">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input id="name" type="text" required
                   class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900">
          </div>

          <div>
            <label class="block mb-1 text-sm font-medium">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
            <input id="phone" type="tel" required
                   class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900"
                   placeholder="01xxxxxxxxx">
          </div>

          <div>
            <label class="block mb-1 text-sm font-medium">Ø±Ù‚Ù… Ù…ÙˆØ¨Ø§ÙŠÙ„ 2 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="phone2" type="tel"
                   class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900"
                   placeholder="01xxxxxxxxx">
          </div>

          <div>
            <label class="block mb-1 text-sm font-medium">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
            <select id="governorate" required
                    class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900">
              <option value="" disabled selected>Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
              <option value="Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©">Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option>
              <option value="Ø§Ù„Ø¬ÙŠØ²Ø©">Ø§Ù„Ø¬ÙŠØ²Ø©</option>
              <option value="Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©">Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©</option>
              <option value="Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©">Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©</option>
              <option value="Ø§Ù„Ø´Ø±Ù‚ÙŠØ©">Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option>
              <option value="Ø§Ù„ØºØ±Ø¨ÙŠØ©">Ø§Ù„ØºØ±Ø¨ÙŠØ©</option>
              <option value="Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©">Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©</option>
              <option value="Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©">Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©</option>
              <option value="ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®">ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</option>
              <option value="Ø§Ù„Ø¨Ø­ÙŠØ±Ø©">Ø§Ù„Ø¨Ø­ÙŠØ±Ø©</option>
              <option value="Ø¯Ù…ÙŠØ§Ø·">Ø¯Ù…ÙŠØ§Ø·</option>
              <option value="Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯">Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯</option>
              <option value="Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©">Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©</option>
              <option value="Ø§Ù„Ø³ÙˆÙŠØ³">Ø§Ù„Ø³ÙˆÙŠØ³</option>
              <option value="Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡">Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡</option>
              <option value="Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡">Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡</option>
              <option value="Ø§Ù„ÙÙŠÙˆÙ…">Ø§Ù„ÙÙŠÙˆÙ…</option>
              <option value="Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ">Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ</option>
              <option value="Ø§Ù„Ù…Ù†ÙŠØ§">Ø§Ù„Ù…Ù†ÙŠØ§</option>
              <option value="Ø£Ø³ÙŠÙˆØ·">Ø£Ø³ÙŠÙˆØ·</option>
              <option value="Ø³ÙˆÙ‡Ø§Ø¬">Ø³ÙˆÙ‡Ø§Ø¬</option>
              <option value="Ù‚Ù†Ø§">Ù‚Ù†Ø§</option>
              <option value="Ø§Ù„Ø£Ù‚ØµØ±">Ø§Ù„Ø£Ù‚ØµØ±</option>
              <option value="Ø£Ø³ÙˆØ§Ù†">Ø£Ø³ÙˆØ§Ù†</option>
              <option value="Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯">Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯</option>
              <option value="Ù…Ø·Ø±ÙˆØ­">Ù…Ø·Ø±ÙˆØ­</option>
              <option value="Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±">Ø§Ù„ØºØ±Ø¯Ù‚Ø© / Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block mb-1 text-sm font-medium">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„</label>
          <textarea id="address" required rows="3"
                    class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900"
                    placeholder="Ø§Ù„Ø¹Ù…Ø§Ø±Ø© â€“ Ø§Ù„Ø´Ø§Ø±Ø¹ â€“ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ù…ÙŠØ²Ø©"></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block mb-1 text-sm font-medium">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="notes" type="text"
                   class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900"
                   placeholder="Ù…Ø«Ø§Ù„: Ù„ÙˆÙ† Ø§Ù„Ø­Ø¬Ø§Ø¨ØŒ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…â€¦">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">Ø§Ù„ÙˆØ²Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="weight" type="text"
                   class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900"
                   placeholder="Ù…Ø«Ø§Ù„: 75 Ùƒ">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… (10Ùª Ù„Ø£ÙˆÙ„ Ø£ÙˆØ±Ø¯Ø±)</label>
            <input id="coupon" type="text"
                   class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900"
                   placeholder="TEFA4434">
          </div>
        </div>

        <p class="text-sm text-gray-600">
          âœ… Ø§Ø·Ù„Ø¨ ÙˆØ§Ù†Øª Ù…Ø·Ù…Ø¦Ù† ÙˆØ¹Ø§ÙŠÙ† Ø¨Ø±Ø§Ø­ØªÙƒ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ğŸ¥°â¤ï¸
        </p>

        <button type="submit"
                class="w-full bg-gray-900 text-white font-bold py-3 rounded-2xl text-lg mt-2 hover:bg-black transition">
          ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†
        </button>

        <p id="form-message" class="text-center text-sm mt-2"></p>
      </form>
    </section>
  </main>

  <!-- Ø³ÙƒØ±Ø¨Øª -->
  <script>
    // Ø±Ø§Ø¨Ø· Google Apps Script Ø¨ØªØ§Ø¹Ùƒ
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyo642ysmxGm2Mhuvjoq76T2CaZaCoNtNegxDD83AqdszaELVOXyut_jTipSJuLEWHh/exec";

    let cart = [];

    // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ù„Ø© Ø¨Ø£ÙŠ ÙÙˆØ±Ù…Ø§Øª Ù‚Ø¯ÙŠÙ…/Ø¬Ø¯ÙŠØ¯
    function getStoredCart() {
      let raw = localStorage.getItem("tefa_cart") || localStorage.getItem("cart");
      if (!raw) return [];
      try {
        const data = JSON.parse(raw);
        if (Array.isArray(data)) return data;
        if (data && Array.isArray(data.items)) return data.items;
        return [];
      } catch {
        return [];
      }
    }

    function getItemTotal(item) {
      const qty = item.quantity ?? item.qty ?? 1;
      if (item.total != null) return Number(item.total) || 0;
      if (item.price != null) return (Number(item.price) || 0) * qty;
      if (item.unitPrice != null) return (Number(item.unitPrice) || 0) * qty;
      return 0;
    }

    function getItemName(item) {
      return item.productName || item.name || item.title || "Ù…Ù†ØªØ¬";
    }

    function getItemColor(item) {
      return item.colorName || item.colorLabel || item.color || "";
    }

    function getItemQty(item) {
      return item.quantity ?? item.qty ?? 1;
    }

    function loadCart() {
      cart = getStoredCart();
      const container = document.getElementById("cart-items");
      const badge = document.getElementById("cart-count-badge");
      container.innerHTML = "";

      if (!cart.length) {
        container.innerHTML = "<p class='text-gray-500 text-sm'>Ø§Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
        badge.classList.add("hidden");
        updateTotals();
        return;
      }

      const totalQty = cart.reduce((sum, item) => sum + getItemQty(item), 0);
      badge.textContent = totalQty;
      badge.classList.remove("hidden");

      cart.forEach((item, index) => {
        const name = getItemName(item);
        const color = getItemColor(item);
        const qty = getItemQty(item);
        const lineTotal = getItemTotal(item);

        const row = document.createElement("div");
        row.className = "flex items-center justify-between border-b pb-2";

        row.innerHTML = `
          <div class="text-sm">
            <div class="font-semibold">${name}</div>
            <div class="text-gray-600">${color ? "Ø§Ù„Ù„ÙˆÙ†: " + color : ""}</div>
            <div class="text-gray-600">Ø§Ù„ÙƒÙ…ÙŠØ©: ${qty}</div>
          </div>
          <div class="flex items-center gap-3">
            <span class="font-bold text-sm">${lineTotal} Ø¬</span>
            <button class="text-xs text-red-500 underline" data-remove="${index}">Ø­Ø°Ù</button>
          </div>
        `;

        container.appendChild(row);
      });

      container.querySelectorAll("[data-remove]").forEach(btn => {
        btn.addEventListener("click", () => {
          const i = parseInt(btn.getAttribute("data-remove"));
          cart.splice(i, 1);
          localStorage.setItem("tefa_cart", JSON.stringify(cart));
          loadCart();
        });
      });

      updateTotals();
    }

    function updateTotals() {
      const subtotal = cart.reduce((sum, item) => sum + getItemTotal(item), 0);
      document.getElementById("subtotal").textContent = subtotal + " Ø¬";

      const gov = document.getElementById("governorate").value;
      let shipping = 0;

      if (gov) {
        // Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ùˆ Ø§Ù„Ø¬ÙŠØ²Ø© 60
        if (gov === "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©" || gov === "Ø§Ù„Ø¬ÙŠØ²Ø©") {
          shipping = 60;
        }
        // Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ® â€“ Ø§Ù„ØºØ±Ø¯Ù‚Ø© â€“ Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­ â€“ Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡ â€“ Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡ â€“ Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ = 120
        else if (["Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡", "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡", "Ù…Ø·Ø±ÙˆØ­", "Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯", "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±"].includes(gov)) {
          shipping = 120;
        }
        // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª 70
        else {
          shipping = 70;
        }
      }

      document.getElementById("shipping").textContent = shipping + " Ø¬";

      const couponInput = document.getElementById("coupon");
      let discount = 0;
      if (couponInput && couponInput.value.trim().toUpperCase() === "TEFA4434") {
        discount = Math.round((subtotal + shipping) * 0.10);
      }
      document.getElementById("discount").textContent = discount + " Ø¬";

      const total = subtotal + shipping - discount;
      document.getElementById("total").textContent = total + " Ø¬";
      return { subtotal, shipping, discount, total };
    }

    document.getElementById("governorate").addEventListener("change", updateTotals);
    document.getElementById("coupon").addEventListener("input", updateTotals);

    document.getElementById("order-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = document.getElementById("form-message");
      msg.textContent = "";
      msg.className = "text-center text-sm mt-2";

      if (!cart.length) {
        msg.textContent = "Ø§Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ©ØŒ Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ù†ØªØ¬ Ø§Ù„Ø£ÙˆÙ„.";
        msg.classList.add("text-red-500");
        return;
      }

      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const phone2 = document.getElementById("phone2").value.trim();
      const governorate = document.getElementById("governorate").value;
      const address = document.getElementById("address").value.trim();
      const notes = document.getElementById("notes").value.trim();
      const weight = document.getElementById("weight").value.trim();

      const totals = updateTotals();

      const productsText = cart.map(item => {
        const n = getItemName(item);
        const c = getItemColor(item);
        const q = getItemQty(item);
        const t = getItemTotal(item);
        return `${n}${c ? " - " + c : ""} Ã—${q} = ${t}Ø¬`;
      }).join("\n");

      const orderData = {
        name,
        phone,
        phone2,
        governorate,
        address,
        notes,
        weight,
        products: productsText,
        total: totals.total
      };

      msg.textContent = "Ø¬Ø§Ø±Ù Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...";
      msg.classList.remove("text-red-500", "text-green-500");
      msg.classList.add("text-gray-600");

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(orderData)
        });
        const data = await res.json();

        if (data && data.result === "success") {
          msg.textContent = "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ â¤ï¸ Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù†.";
          msg.classList.remove("text-gray-600");
          msg.classList.add("text-green-600");

          localStorage.removeItem("tefa_cart");
          cart = [];
          loadCart();
        } else {
          throw new Error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©");
        }
      } catch (err) {
        console.error(err);
        msg.textContent = "Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ØŒ Ø­Ø§ÙˆÙ„ÙŠ ØªØ§Ù†ÙŠ Ø£Ùˆ ØªÙˆØ§ØµÙ„ÙŠ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨.";
        msg.classList.remove("text-gray-600");
        msg.classList.add("text-red-500");
      }
    });

    loadCart();
  </script>

</body>
</html>