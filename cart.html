<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ุณูุฉ ุงูุทูุจุงุช | TEFA STORE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      background: #f5f5f7;
      color: #111827;
    }

    header {
      background: #111827;
      color: #fff;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header .logo {
      font-weight: 800;
      letter-spacing: 1px;
      font-size: 18px;
    }

    header .cart-icon {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: #f97316;
      color: #111827;
      font-size: 18px;
      text-decoration: none;
    }

    header .cart-count {
      position: absolute;
      top: -6px;
      left: -6px;
      background: #ef4444;
      color: #fff;
      font-size: 11px;
      padding: 1px 5px;
      border-radius: 999px;
      min-width: 18px;
      text-align: center;
    }

    main {
      max-width: 960px;
      margin: 16px auto 32px;
      padding: 0 12px;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.04);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .card-header h2 {
      font-size: 18px;
    }

    .empty-cart {
      text-align: center;
      padding: 32px 16px;
      color: #6b7280;
      font-size: 14px;
    }

    .cart-item {
      display: flex;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .cart-item-details {
      flex: 1;
    }

    .cart-item-title {
      font-weight: 700;
      margin-bottom: 4px;
      font-size: 15px;
    }

    .cart-item-color {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .color-dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      margin-left: 4px;
      vertical-align: middle;
    }

    .cart-item-price {
      font-size: 14px;
      font-weight: 600;
      color: #16a34a;
      margin-bottom: 6px;
    }

    .cart-item-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .qty-btn {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
    }

    .qty-value {
      min-width: 24px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
    }

    .remove-btn {
      font-size: 12px;
      color: #ef4444;
      border: none;
      background: transparent;
      text-decoration: underline;
      cursor: pointer;
    }

    .totals-row {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
      font-size: 14px;
    }

    .totals-row strong {
      font-weight: 700;
    }

    .totals-row.total {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed #e5e7eb;
      font-size: 16px;
    }

    .totals-row.total strong {
      color: #16a34a;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #fee2e2;
      color: #b91c1c;
      margin-bottom: 4px;
    }

    form label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
      font-weight: 600;
    }

    form input,
    form select,
    form textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      font-size: 14px;
      margin-bottom: 10px;
      background: #f9fafb;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background 0.15s ease;
    }

    form input:focus,
    form select:focus,
    form textarea:focus {
      outline: none;
      background: #fff;
      border-color: #111827;
      box-shadow: 0 0 0 1px rgba(17, 24, 39, 0.08);
    }

    form textarea {
      min-height: 60px;
      resize: vertical;
    }

    .hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: -6px;
      margin-bottom: 8px;
    }

    .two-cols {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .two-cols > div {
      flex: 1 1 0;
      min-width: 0;
    }

    .btn-main {
      width: 100%;
      padding: 12px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: #fff;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 4px;
    }

    .btn-main:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .note {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
      text-align: center;
    }

    .discount-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: nowrap;
    }

    .discount-row input {
      margin-bottom: 0;
      flex: 1;
    }

    .btn-secondary {
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      background: #f97316;
      color: #111827;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    @media (min-width: 800px) {
      .layout {
        display: grid;
        grid-template-columns: 3fr 2fr;
        gap: 16px;
      }
    }
  </style>
</head>
<body>
<header>
  <div class="logo">TEFA STORE</div>
  <a href="cart.html" class="cart-icon" aria-label="ุณูุฉ ุงูุทูุจุงุช">
    ๐
    <span class="cart-count" id="cartCount">0</span>
  </a>
</header>

<main>
  <h1>ุณูุฉ ุงูุทูุจุงุช</h1>
  <p class="subtitle">
    ุฑุงุฌุน ุงุฎุชูุงุฑุงุชูุ ุซู ุงูุชุจ ุจูุงูุงุช ุงูุชูุตูู ูุงุถุบุท ุชุฃููุฏ ุงูุทูุจ โจ
  </p>

  <div class="layout">
    <!-- ุงูุณูุฉ -->
    <section class="card" id="cartCard">
      <div class="card-header">
        <h2>ุงูููุชุฌุงุช ุงููุฎุชุงุฑุฉ</h2>
      </div>
      <div id="cartItems"></div>
      <div id="emptyCart" class="empty-cart" style="display:none;">
        ุงูุณูุฉ ูุงุถูุฉ ุญุงููุงู ๐<br/>ุงุฑุฌุน ููุตูุญุฉ ุงูุฑุฆูุณูุฉ ูุงุฎุชุงุฑ ุงูููุฏููุงุช ุงููู ุชุนุฌุจู.
      </div>

      <div id="totalsBox" style="margin-top:12px; display:none;">
        <div class="badge">๐ ุงูุดุญู ุญุณุจ ุงููุญุงูุธุฉ</div>

        <div class="totals-row">
          <span>ุฅุฌูุงูู ุงูููุชุฌุงุช</span>
          <span id="itemsTotal">0 ุฌ</span>
        </div>
        <div class="totals-row">
          <span>ุงูุดุญู</span>
          <span id="shippingTotal">0 ุฌ</span>
        </div>
        <div class="totals-row" id="discountRow" style="display:none;">
          <span>ุฎุตู ุงูููุจูู</span>
          <span id="discountAmount">-0 ุฌ</span>
        </div>
        <div class="totals-row total">
          <strong>ุงูุฅุฌูุงูู ุจุนุฏ ุงูุดุญู</strong>
          <strong id="grandTotal">0 ุฌ</strong>
        </div>
      </div>
    </section>

    <!-- ุจูุงูุงุช ุงูุนููู -->
    <section class="card">
      <div class="card-header">
        <h2>ุจูุงูุงุช ุงูุชูุตูู</h2>
      </div>

      <div class="badge" style="background:#dcfce7; color:#166534;">
        ๐ธ ุฎุตู 10ูช ูุฃูู ุฃูุฑุฏุฑ ุจููุฏ TEFA4434
      </div>
      <p class="hint" style="margin-bottom:10px;">
        ุฎุตู ุจูุชุทุจู ุชููุงุฆูุงู ูู ุงูููุฏ ุตุญูุญ.
      </p>

      <form id="orderForm">
        <label for="name">ุงูุงุณู ุงูุซูุงุซู *</label>
        <input id="name" required placeholder="ูุซุงู: ุขูุฉ ูุญูุฏ ุฃุญูุฏ" />

        <div class="two-cols">
          <div>
            <label for="phone">ููุจุงูู ูุงุชุณุงุจ *</label>
            <input
              id="phone"
              required
              inputmode="tel"
              placeholder="01xxxxxxxxx"
            />
          </div>
          <div>
            <label for="phone2">ููุจุงูู ุจุฏูู (ุงุฎุชูุงุฑู)</label>
            <input
              id="phone2"
              inputmode="tel"
              placeholder="ุฑูู ุชุงูู ูู ุญุงุจุจ"
            />
          </div>
        </div>

        <label for="governorate">ุงููุญุงูุธุฉ *</label>
        <select id="governorate" required>
          <option value="">ุงุฎุชุงุฑ ุงููุญุงูุธุฉ</option>
          <option>ุงููุงูุฑุฉ</option>
          <option>ุงูุฌูุฒุฉ</option>
          <option>ุงูููููุจูุฉ</option>
          <option>ุงูุฅุณููุฏุฑูุฉ</option>
          <option>ุงูุจุญูุฑุฉ</option>
          <option>ููุฑ ุงูุดูุฎ</option>
          <option>ุงูุฏููููุฉ</option>
          <option>ุฏููุงุท</option>
          <option>ุจูุฑุณุนูุฏ</option>
          <option>ุงูุฅุณูุงุนูููุฉ</option>
          <option>ุงูุณููุณ</option>
          <option>ุงูุดุฑููุฉ</option>
          <option>ุงูุบุฑุจูุฉ</option>
          <option>ุงููููููุฉ</option>
          <option>ุจูู ุณููู</option>
          <option>ุงููููู</option>
          <option>ุงููููุง</option>
          <option>ุฃุณููุท</option>
          <option>ุณููุงุฌ</option>
          <option>ููุง</option>
          <option>ุงูุฃูุตุฑ</option>
          <option>ุฃุณูุงู</option>
          <option>ุงูุจุญุฑ ุงูุฃุญูุฑ</option>
          <option>ูุฑุณู ูุทุฑูุญ</option>
          <option>ุดูุงู ุณููุงุก</option>
          <option>ุฌููุจ ุณููุงุก</option>
          <option>ุงููุงุฏู ุงูุฌุฏูุฏ</option>
          <option>ุดุฑู ุงูุดูุฎ</option>
          <option>ุงูุบุฑุฏูุฉ</option>
        </select>

        <label for="address">ุงูุนููุงู ุจุงูุชูุตูู *</label>
        <textarea
          id="address"
          required
          placeholder="ุงููุฑูุฒ / ุงูููุทูุฉ - ุงุณู ุงูุดุงุฑุน - ุฑูู ุงูููุฒู / ุงูุนูุงุฑุฉ - ุฃูุฑุจ ุนูุงูุฉ ูููุฒุฉ"
        ></textarea>

        <label for="notes">ููุงุญุธุงุช (ุงุฎุชูุงุฑู)</label>
        <textarea
          id="notes"
          placeholder="ูุซูุงู: ูุงุณุน ุดููุฉุ ููุถู ุงุชุตุงู ูุจู ุงูุดุญู .."
        ></textarea>

        <div class="two-cols">
          <div>
            <label for="height">ุงูุทูู (ุงุฎุชูุงุฑู)</label>
            <input id="height" placeholder="ูุซุงู 165 ุณู" />
          </div>
          <div>
            <label for="weight">ุงููุฒู (ุงุฎุชูุงุฑู)</label>
            <input id="weight" placeholder="ูุซุงู 75 ู" />
          </div>
        </div>

        <div class="discount-row">
          <input
            id="coupon"
            placeholder="ูู ูุนุงู ููุฏ ุฎุตู ุงูุชุจู ููุง"
          />
          <button type="button" class="btn-secondary" id="applyCouponBtn">
            ุชุทุจูู ุงูููุฏ
          </button>
        </div>
        <p class="hint">
          ููุฏ ุงูุฎุตู ุงูุญุงูู: <strong>TEFA4434</strong> ุฎุตู 10ูช ูุฃูู ุฃูุฑุฏุฑ.
        </p>

        <button type="submit" class="btn-main" id="submitBtn">
          ุชุฃููุฏ ุงูุทูุจ ุงูุขู
        </button>
        <p class="note">
          ูููุด ุฃู ุฏูุน ุฃูููุงูู ๐ณ โ ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู ุจุนุฏ ุงููุนุงููุฉ ุจุฑุงุญุชู.
        </p>
      </form>
    </section>
  </div>
</main>

<script>
  // ๐ ูููู Google Apps Script
  const SCRIPT_URL =
    "https://script.google.com/macros/s/AKfycbwPgm3Ez315GP5_E4SyM-NOjId3Whah4tdrXCRCHF1wYlk_CVwEgs4kd8WHCpJ50ggpiw/exec";

  // ๐ ุงูููุชุงุญ ุงูููุญุฏ ููุณูุฉ
  const CART_KEY = "tefa_cart";

  const cartCountEl = document.getElementById("cartCount");
  const cartItemsEl = document.getElementById("cartItems");
  const emptyCartEl = document.getElementById("emptyCart");
  const totalsBoxEl = document.getElementById("totalsBox");
  const itemsTotalEl = document.getElementById("itemsTotal");
  const shippingTotalEl = document.getElementById("shippingTotal");
  const discountRowEl = document.getElementById("discountRow");
  const discountAmountEl = document.getElementById("discountAmount");
  const grandTotalEl = document.getElementById("grandTotal");
  const governorateEl = document.getElementById("governorate");
  const couponInput = document.getElementById("coupon");
  const applyCouponBtn = document.getElementById("applyCouponBtn");

  let cart = [];
  let discountValue = 0;

  // ุฏุงููุงู ููุฑุฃ ุงูุณูุฉ ูู localStorage
  function getStoredCart() {
    try {
      const stored = localStorage.getItem(CART_KEY);
      const parsed = stored ? JSON.parse(stored) : [];
      return Array.isArray(parsed) ? parsed : [];
    } catch (e) {
      return [];
    }
  }

  function loadCart() {
    cart = getStoredCart();
    updateCartBadge();
    renderCart();
  }

  function saveCart() {
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
    updateCartBadge();
  }

  function updateCartBadge() {
    const currentCart = getStoredCart();
    const count = currentCart.reduce((sum, item) => sum + (item.qty || 1), 0);
    cartCountEl.textContent = count;
  }

  function renderCart() {
    cart = getStoredCart();
    cartItemsEl.innerHTML = "";
    if (cart.length === 0) {
      emptyCartEl.style.display = "block";
      totalsBoxEl.style.display = "none";
      itemsTotalEl.textContent = "0 ุฌ";
      shippingTotalEl.textContent = "0 ุฌ";
      grandTotalEl.textContent = "0 ุฌ";
      return;
    }
    emptyCartEl.style.display = "none";
    totalsBoxEl.style.display = "block";

    cart.forEach((item, index) => {
      const row = document.createElement("div");
      row.className = "cart-item";

      const details = document.createElement("div");
      details.className = "cart-item-details";

      const title = document.createElement("div");
      title.className = "cart-item-title";
      title.textContent = item.name || "ููุชุฌ ุจุฏูู ุงุณู";

      const color = document.createElement("div");
      color.className = "cart-item-color";
      if (item.colorName) {
        const dot = document.createElement("span");
        dot.className = "color-dot";
        if (item.colorCode || item.colorHex || item.color) {
          dot.style.background =
            item.colorCode || item.colorHex || item.color;
        }
        color.appendChild(dot);
        color.appendChild(
          document.createTextNode(" ุงูููู: " + item.colorName)
        );
      } else {
        color.textContent = "ุงูููู: ุบูุฑ ูุญุฏุฏ";
      }

      const price = document.createElement("div");
      price.className = "cart-item-price";
      price.textContent = (item.price || 0) + " ุฌ";

      const actions = document.createElement("div");
      actions.className = "cart-item-actions";

      const minus = document.createElement("button");
      minus.type = "button";
      minus.className = "qty-btn";
      minus.textContent = "โ";
      minus.addEventListener("click", () => changeQty(index, -1));

      const qty = document.createElement("div");
      qty.className = "qty-value";
      qty.textContent = item.qty || 1;

      const plus = document.createElement("button");
      plus.type = "button";
      plus.className = "qty-btn";
      plus.textContent = "+";
      plus.addEventListener("click", () => changeQty(index, +1));

      const remove = document.createElement("button");
      remove.type = "button";
      remove.className = "remove-btn";
      remove.textContent = "ุฅุฒุงูุฉ ุงูููู";
      remove.addEventListener("click", () => removeItem(index));

      actions.appendChild(minus);
      actions.appendChild(qty);
      actions.appendChild(plus);
      actions.appendChild(remove);

      details.appendChild(title);
      details.appendChild(color);
      details.appendChild(price);
      details.appendChild(actions);

      row.appendChild(details);
      cartItemsEl.appendChild(row);
    });

    updateTotals();
  }

  function changeQty(index, delta) {
    cart = getStoredCart();
    const item = cart[index];
    if (!item) return;
    let newQty = (item.qty || 1) + delta;
    if (newQty < 1) newQty = 1;
    if (newQty > 20) newQty = 20;
    item.qty = newQty;
    saveCart();
    renderCart();
  }

  function removeItem(index) {
    cart = getStoredCart();
    cart.splice(index, 1);
    saveCart();
    renderCart();
  }

  function getShippingForGovernorate(gov) {
    if (!gov) return 0;

    const special120 = [
      "ุดุฑู ุงูุดูุฎ",
      "ุงูุบุฑุฏูุฉ",
      "ูุฑุณู ูุทุฑูุญ",
      "ุดูุงู ุณููุงุก",
      "ุฌููุจ ุณููุงุก",
      "ุงููุงุฏู ุงูุฌุฏูุฏ",
    ];

    if (gov === "ุงููุงูุฑุฉ" || gov === "ุงูุฌูุฒุฉ") return 60;
    if (special120.includes(gov)) return 120;
    return 70;
  }

  function updateTotals() {
    cart = getStoredCart();

    const itemsTotal = cart.reduce(
      (sum, item) => sum + (item.price || 0) * (item.qty || 1),
      0
    );

    const gov = governorateEl.value || "";
    const shipping = getShippingForGovernorate(gov);

    const discount = discountValue ? Math.round(itemsTotal * discountValue) : 0;
    const grand = itemsTotal + shipping - discount;

    itemsTotalEl.textContent = itemsTotal + " ุฌ";
    shippingTotalEl.textContent = shipping + " ุฌ";

    if (discount > 0) {
      discountRowEl.style.display = "flex";
      discountAmountEl.textContent = "-" + discount + " ุฌ";
    } else {
      discountRowEl.style.display = "none";
    }

    grandTotalEl.textContent = grand + " ุฌ";
  }

  governorateEl.addEventListener("change", updateTotals);

  // ููุจูู ุงูุฎุตู
  applyCouponBtn.addEventListener("click", () => {
    const code = couponInput.value.trim().toUpperCase();
    if (!code) {
      alert("ุงูุชุจ ููุฏ ุงูุฎุตู ุงูุฃูู.");
      return;
    }
    if (code !== "TEFA4434") {
      alert("ุงูููุฏ ุบูุฑ ุตุญูุญ ุฃู ููุชูู.");
      discountValue = 0;
      updateTotals();
      return;
    }
    discountValue = 0.1;
    alert("ุชู ุชุทุจูู ููุฏ ุงูุฎุตู 10ูช ุจูุฌุงุญ ๐");
    updateTotals();
  });

  // ุฅุฑุณุงู ุงูุทูุจ ูู Google Sheet
  document
    .getElementById("orderForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      cart = getStoredCart();

      if (cart.length === 0) {
        alert("ุงูุณูุฉ ูุงุถูุฉุ ุงุฎุชุงุฑ ููุชุฌ ูุงุญุฏ ุนูู ุงูุฃูู.");
        return;
      }

      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const phone2 = document.getElementById("phone2").value.trim();
      const governorate = governorateEl.value;
      const address = document.getElementById("address").value.trim();
      const notes = document.getElementById("notes").value.trim();
      const height = document.getElementById("height").value.trim();
      const weight = document.getElementById("weight").value.trim();

      if (!name || !phone || !governorate || !address) {
        alert(
          "ูู ูุถูู ุงููุฃ ุงูุญููู ุงูุฃุณุงุณูุฉ (ุงูุงุณู - ุงูููุจุงูู - ุงููุญุงูุธุฉ - ุงูุนููุงู)."
        );
        return;
      }

      const itemsSummary = cart
        .map(
          (item) =>
            `${item.name || "ููุชุฌ"} - ${item.colorName || "ุจุฏูู ููู"} ร ${
              item.qty || 1
            }`
        )
        .join(" | ");

      const itemsTotal = cart.reduce(
        (sum, item) => sum + (item.price || 0) * (item.qty || 1),
        0
      );
      const shipping = getShippingForGovernorate(governorate);
      const discount = discountValue ? Math.round(itemsTotal * discountValue) : 0;
      const grand = itemsTotal + shipping - discount;

      const payload = {
        name,
        phone,
        phone2,
        governorate,
        address,
        notes,
        height,
        weight,
        products: itemsSummary,
        itemsTotal,
        shipping,
        discount,
        total: grand,
        source: "TEFA STORE",
      };

      const submitBtn = document.getElementById("submitBtn");
      submitBtn.disabled = true;
      submitBtn.textContent = "ุฌุงุฑู ุฅุฑุณุงู ุงูุทูุจ ...";

      try {
        await fetch(SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: {
            "Content-Type": "application/json",
          },
    