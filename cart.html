<script>
// Ù…ÙØ§ØªÙŠØ­ Ù…Ø­ØªÙ…Ù„Ø© Ù„Ø¹Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙÙŠ localStorage
const CART_KEYS = ['tefa_cart', 'tefaCart', 'cartItems', 'cart'];
let activeCartKey = null;

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¨Ø© Ù…Ù† localStorage
function loadCart() {
  for (const key of CART_KEYS) {
    const raw = localStorage.getItem(key);
    if (!raw) continue;

    try {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) {
        activeCartKey = key;
        return parsed;
      }
    } catch (e) {
      console.warn('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ø±Ø¨Ø© Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­', key, e);
    }
  }
  // Ù„Ùˆ Ù…ÙÙŠØ´ Ø£ÙŠ Ø­Ø§Ø¬Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„ Ù…ÙØªØ§Ø­ ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
  activeCartKey = CART_KEYS[0];
  return [];
}

// Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¨Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù„ÙŠ Ù„Ù‚ÙŠÙ†Ø§Ù‡
function saveCart(cart) {
  if (!activeCartKey) activeCartKey = CART_KEYS[0];
  localStorage.setItem(activeCartKey, JSON.stringify(cart));
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø³Ù„Ø© ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯)
function updateCartBadge(cart) {
  const count = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
  const badgeEls = document.querySelectorAll('[data-cart-count]');
  badgeEls.forEach(el => {
    el.textContent = count;
    el.style.display = count > 0 ? 'inline-flex' : 'none';
  });
}

// Ø±Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© Ø§Ù„Ø³Ù„Ø©
function renderCart() {
  const cart = loadCart();
  const container = document.getElementById('cart-items');
  const totalEl = document.getElementById('cart-total');
  const emptyMsg = document.getElementById('empty-cart-message');

  container.innerHTML = '';

  if (!cart.length) {
    emptyMsg.style.display = 'block';
    totalEl.textContent = '0';
    updateCartBadge(cart);
    return;
  }

  emptyMsg.style.display = 'none';

  let total = 0;

  cart.forEach((item, index) => {
    const li = document.createElement('div');
    li.className = 'cart-item';

    const quantity = item.quantity || 1;
    const price = Number(item.price) || 0;
    const itemTotal = price * quantity;
    total += itemTotal;

    li.innerHTML = `
      <div class="cart-item-main">
        <div class="cart-item-info">
          <div class="cart-item-name">${item.name || 'Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</div>
          <div class="cart-item-meta">
            ${item.colorText ? `<span>Ø§Ù„Ù„ÙˆÙ†: ${item.colorText}</span>` : ''}
            <span>Ø§Ù„ÙƒÙ…ÙŠØ©: ${quantity}</span>
          </div>
        </div>
        <div class="cart-item-price">
          <div>${itemTotal.toFixed(0)} Ø¬</div>
          <button class="remove-btn" data-index="${index}">Ø­Ø°Ù</button>
        </div>
      </div>
    `;

    container.appendChild(li);
  });

  totalEl.textContent = total.toFixed(0);
  updateCartBadge(cart);

  // Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù
  container.querySelectorAll('.remove-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const i = Number(btn.dataset.index);
      const cartNow = loadCart();
      cartNow.splice(i, 1);
      saveCart(cartNow);
      renderCart();
    });
  });
}

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Google Sheet
async function submitOrder(e) {
  e.preventDefault();

  const cart = loadCart();
  if (!cart.length) {
    alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ©ØŒ Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ù†ØªØ¬ Ø§Ù„Ø£ÙˆÙ„ ğŸ’•');
    return;
  }

  const name = document.getElementById('customer-name').value.trim();
  const phone = document.getElementById('customer-phone').value.trim();
  const phone2 = document.getElementById('customer-phone2').value.trim();
  const governorate = document.getElementById('customer-governorate').value.trim();
  const address = document.getElementById('customer-address').value.trim();
  const notes = document.getElementById('order-notes').value.trim();
  const lengthField = document.getElementById('customer-length').value.trim();
  const total = document.getElementById('cart-total').textContent.trim();

  if (!name || !phone || !governorate || !address) {
    alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒÙ…Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ø§Ø³Ù… â€“ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ â€“ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© â€“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†) ğŸŒ·');
    return;
  }

  // ØªØ¬Ù‡ÙŠØ² ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  const productsDescription = cart.map(item => {
    const q = item.quantity || 1;
    const color = item.colorText ? `ØŒ Ø§Ù„Ù„ÙˆÙ†: ${item.colorText}` : '';
    return `${item.name || 'Ù…Ù†ØªØ¬'} (Ø¹Ø¯Ø¯: ${q}${color})`;
  }).join(' | ');

  const payload = {
    name,
    phone,
    phone2,
    governorate,
    address,
    notes,
    length: lengthField,
    total,
    products: productsDescription
  };

  try {
    const response = await fetch(
      'https://script.google.com/macros/s/AKfycbwPgm3Ez315GP5_E4SyM-NOjId3Whah4tdrXCRCHF1wYlk_CVwEgs4kd8WHCpJ50ggpiw/exec',
      {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      }
    );

    // Ù„Ùˆ ÙˆØµÙ„Ù†Ø§ Ù‡Ù†Ø§ Ù…Ù† ØºÙŠØ± error Ù‡Ù†Ø¹ØªØ¨Ø±Ù‡ Ù†Ø¬Ø§Ø­
    alert('ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ ğŸ’– Ù‡Ù†ÙƒÙ„Ù…Ùƒ Ù„ØªØ£ÙƒÙŠØ¯Ù‡ ÙÙŠ Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª.');
    // ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
    saveCart([]);
    renderCart();
  } catch (err) {
    console.error(err);
    alert('ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Google Sheet. Ù„Ùˆ Ø³Ù…Ø­ØªÙŠ ÙƒÙ„Ù…ÙŠÙ†Ø§ ÙˆØ§ØªØ³Ø§Ø¨ Ù„ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ ğŸŒ¸');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  renderCart();

  const form = document.getElementById('checkout-form');
  if (form) {
    form.addEventListener('submit', submitOrder);
  }
});
</script>