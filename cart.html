<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TEFA STORE | ุฅููุงุก ุงูุทูุจ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

  <!-- ุงูููุฏุฑ -->
  <header class="bg-gray-900 text-white py-4 shadow">
    <div class="container mx-auto px-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="bg-white text-gray-900 font-bold px-3 py-1 rounded-full text-sm">TS</span>
        <h1 class="text-xl font-bold">TEFA STORE</h1>
      </div>

      <a href="cart.html" class="relative">
        <span class="material-icons">shopping_cart</span>
        <span id="cart-count-badge"
              class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">
          0
        </span>
      </a>
    </div>
  </header>

  <!-- ุงููุญุชูู -->
  <main class="container mx-auto px-4 py-6 space-y-6">

    <!-- ููุฎุต ุงูุณูุฉ -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-bold mb-3">ุณูุฉ ุงูููุชุฌุงุช</h2>
      <div id="cart-items" class="space-y-3"></div>

      <div class="border-t pt-3 mt-3 text-sm">
        <div class="flex justify-between mb-1">
          <span>ุฅุฌูุงูู ุงูููุชุฌุงุช</span>
          <span id="subtotal">0 ุฌ</span>
        </div>
        <div class="flex justify-between mb-1">
          <span>ุงูุดุญู</span>
          <span id="shipping">0 ุฌ</span>
        </div>
        <div class="flex justify-between mb-1 text-green-600">
          <span>ุงูุฎุตู (ูู ููู ููุฏ)</span>
          <span id="discount">0 ุฌ</span>
        </div>
        <div class="flex justify-between font-bold text-lg mt-2">
          <span>ุงูุฅุฌูุงูู ุจุนุฏ ุงูุฎุตู</span>
          <span id="total">0 ุฌ</span>
        </div>
      </div>
    </section>

    <!-- ุจูุงูุงุช ุงูุนููู -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-bold mb-4">ุจูุงูุงุช ุงูุชูุตูู</h2>

      <form id="order-form" class="space-y-4">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-1 text-sm font-medium">ุงูุงุณู ุงููุงูู</label>
            <input id="name" type="text" required
                   class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900">
          </div>

          <div>
            <label class="block mb-1 text-sm font-medium">ุฑูู ุงูููุจุงูู</label>
            <input id="phone" type="tel" required
                   class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900"
                   placeholder="01xxxxxxxxx">
          </div>

          <div>
            <label class="block mb-1 text-sm font-medium">ุฑูู ููุจุงูู 2 (ุงุฎุชูุงุฑู)</label>
            <input id="phone2" type="tel"
                   class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900"
                   placeholder="01xxxxxxxxx">
          </div>

          <div>
            <label class="block mb-1 text-sm font-medium">ุงููุญุงูุธุฉ</label>
            <select id="governorate" required
                    class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900">
              <option value="" disabled selected>ุงุฎุชุงุฑู ุงููุญุงูุธุฉ</option>
              <option value="ุงููุงูุฑุฉ">ุงููุงูุฑุฉ</option>
              <option value="ุงูุฌูุฒุฉ">ุงูุฌูุฒุฉ</option>
              <option value="ุงูุฅุณููุฏุฑูุฉ">ุงูุฅุณููุฏุฑูุฉ</option>
              <option value="ุงูุฏููููุฉ">ุงูุฏููููุฉ</option>
              <option value="ุงูุดุฑููุฉ">ุงูุดุฑููุฉ</option>
              <option value="ุงูุบุฑุจูุฉ">ุงูุบุฑุจูุฉ</option>
              <option value="ุงููููููุฉ">ุงููููููุฉ</option>
              <option value="ุงูููููุจูุฉ">ุงูููููุจูุฉ</option>
              <option value="ููุฑ ุงูุดูุฎ">ููุฑ ุงูุดูุฎ</option>
              <option value="ุงูุจุญูุฑุฉ">ุงูุจุญูุฑุฉ</option>
              <option value="ุฏููุงุท">ุฏููุงุท</option>
              <option value="ุจูุฑุณุนูุฏ">ุจูุฑุณุนูุฏ</option>
              <option value="ุงูุฅุณูุงุนูููุฉ">ุงูุฅุณูุงุนูููุฉ</option>
              <option value="ุงูุณููุณ">ุงูุณููุณ</option>
              <option value="ุดูุงู ุณููุงุก">ุดูุงู ุณููุงุก</option>
              <option value="ุฌููุจ ุณููุงุก">ุฌููุจ ุณููุงุก</option>
              <option value="ุงููููู">ุงููููู</option>
              <option value="ุจูู ุณููู">ุจูู ุณููู</option>
              <option value="ุงููููุง">ุงููููุง</option>
              <option value="ุฃุณููุท">ุฃุณููุท</option>
              <option value="ุณููุงุฌ">ุณููุงุฌ</option>
              <option value="ููุง">ููุง</option>
              <option value="ุงูุฃูุตุฑ">ุงูุฃูุตุฑ</option>
              <option value="ุฃุณูุงู">ุฃุณูุงู</option>
              <option value="ุงููุงุฏู ุงูุฌุฏูุฏ">ุงููุงุฏู ุงูุฌุฏูุฏ</option>
              <option value="ูุทุฑูุญ">ูุฑุณู ูุทุฑูุญ / ูุทุฑูุญ</option>
              <option value="ุงูุจุญุฑ ุงูุฃุญูุฑ">ุงูุบุฑุฏูุฉ / ุงูุจุญุฑ ุงูุฃุญูุฑ</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block mb-1 text-sm font-medium">ุงูุนููุงู ุจุงูุชูุตูู</label>
          <textarea id="address" required rows="3"
                    class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900"
                    placeholder="ุงูุนูุงุฑุฉ โ ุงูุดุงุฑุน โ ุงูุนูุงูุฉ ุงููููุฒุฉ"></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block mb-1 text-sm font-medium">ููุงุญุธุงุช (ุงุฎุชูุงุฑู)</label>
            <input id="notes" type="text"
                   class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900"
                   placeholder="ูุซุงู: ููู ุงูุญุฌุงุจุ ููุงุนูุฏ ุงูุงุณุชูุงูโฆ">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">ุงููุฒู (ุงุฎุชูุงุฑู)</label>
            <input id="weight" type="text"
                   class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900"
                   placeholder="ูุซุงู: 75 ู">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">ููุฏ ุงูุฎุตู (10ูช ูุฃูู ุฃูุฑุฏุฑ)</label>
            <input id="coupon" type="text"
                   class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900"
                   placeholder="TEFA4434">
          </div>
        </div>

        <p class="text-sm text-gray-600">
          โ ุงุทูุจ ูุงูุช ูุทูุฆู ูุนุงูู ุจุฑุงุญุชู ูุจู ุงูุงุณุชูุงู ๐ฅฐโค๏ธ
        </p>

        <button type="submit"
                class="w-full bg-gray-900 text-white font-bold py-3 rounded-2xl text-lg mt-2 hover:bg-black transition">
          ุชุฃููุฏ ุงูุทูุจ ุงูุขู
        </button>

        <p id="form-message" class="text-center text-sm mt-2"></p>
      </form>
    </section>
  </main>

  <!-- ุณูุฑุจุช -->
  <script>
    // ุฑุงุจุท Google Apps Script ุจุชุงุนู
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyo642ysmxGm2Mhuvjoq76T2CaZaCoNtNegxDD83AqdszaELVOXyut_jTipSJuLEWHh/exec";

    let cart = [];

    // ูุฑุงุกุฉ ุงูุณูุฉ ูู localStorage (ููุชุงุญ ูุฏูู/ุฌุฏูุฏ)
    function getStoredCart() {
      let raw = localStorage.getItem("tefa_cart") || localStorage.getItem("cart");
      if (!raw) return [];
      try {
        const data = JSON.parse(raw);
        if (Array.isArray(data)) return data;
        if (data && Array.isArray(data.items)) return data.items;
        return [];
      } catch {
        return [];
      }
    }

    function saveCart() {
      if (cart.length === 0) {
        localStorage.removeItem("tefa_cart");
        localStorage.removeItem("cart");
      } else {
        const str = JSON.stringify(cart);
        localStorage.setItem("tefa_cart", str);
        localStorage.setItem("cart", str);
      }
    }

    function getItemTotal(item) {
      const qty = item.quantity ?? item.qty ?? 1;
      if (item.total != null) return Number(item.total) || 0;
      if (item.price != null) return (Number(item.price) || 0) * qty;
      if (item.unitPrice != null) return (Number(item.unitPrice) || 0) * qty;
      return 0;
    }

    function getItemName(item) {
      return item.productName || item.name || item.title || "ููุชุฌ";
    }

    function getItemColor(item) {
      return item.colorName || item.colorLabel || item.color || "";
    }

    function getItemQty(item) {
      return item.quantity ?? item.qty ?? 1;
    }

    function updateBadge() {
      const badge = document.getElementById("cart-count-badge");
      const totalQty = cart.reduce((sum, item) => sum + getItemQty(item), 0);
      if (totalQty > 0) {
        badge.textContent = totalQty;
        badge.classList.remove("hidden");
      } else {
        badge.textContent = "0";
        badge.classList.add("hidden");
      }
    }

    function loadCart() {
      cart = getStoredCart();
      const container = document.getElementById("cart-items");
      container.innerHTML = "";

      if (!cart.length) {
        container.innerHTML = "<p class='text-gray-500 text-sm'>ุงูุณูุฉ ูุงุถูุฉ ุญุงููุงู.</p>";
        updateBadge();
        updateTotals();
        return;
      }

      cart.forEach((item, index) => {
        const name = getItemName(item);
        const color = getItemColor(item);
        const qty = getItemQty(item);
        const lineTotal = getItemTotal(item);

        const row = document.createElement("div");
        row.className = "flex items-center justify-between border-b pb-2";

        row.innerHTML = `
          <div class="text-sm">
            <div class="font-semibold">${name}</div>
            <div class="text-gray-600">${color ? "ุงูููู: " + color : ""}</div>
            <div class="text-gray-600">ุงููููุฉ: ${qty}</div>
          </div>
          <div class="flex items-center gap-3">
            <span class="font-bold text-sm">${lineTotal} ุฌ</span>
            <button class="text-xs text-red-500 underline" data-remove="${index}">ุญุฐู</button>
          </div>
        `;

        container.appendChild(row);
      });

      // ุฃุฒุฑุงุฑ ุงูุญุฐู
      container.querySelectorAll("[data-remove]").forEach(btn => {
        btn.addEventListener("click", () => {
          const i = parseInt(btn.getAttribute("data-remove"));
          cart.splice(i, 1);
          saveCart();
          loadCart();
        });
      });

      updateBadge();
      updateTotals();
    }

    function updateTotals() {
      const subtotal = cart.reduce((sum, item) => sum + getItemTotal(item), 0);
      document.getElementById("subtotal").textContent = subtotal + " ุฌ";

      const gov = document.getElementById("governorate").value;
      let shipping = 0;

      if (gov) {
        // ุงููุงูุฑุฉ ู ุงูุฌูุฒุฉ 60
        if (gov === "ุงููุงูุฑุฉ" || gov === "ุงูุฌูุฒุฉ") {
          shipping = 60;
        }
        // ุดุฑู ุงูุดูุฎ โ ุงูุบุฑุฏูุฉ โ ูุฑุณู ูุทุฑูุญ โ ุดูุงู ุณููุงุก โ ุฌููุจ ุณููุงุก โ ุงููุงุฏู ุงูุฌุฏูุฏ = 120
        else if (["ุฌููุจ ุณููุงุก", "ุดูุงู ุณููุงุก", "ูุทุฑูุญ", "ุงููุงุฏู ุงูุฌุฏูุฏ", "ุงูุจุญุฑ ุงูุฃุญูุฑ"].includes(gov)) {
          shipping = 120;
        }
        // ุจุงูู ุงููุญุงูุธุงุช 70
        else {
          shipping = 70;
        }
      }

      document.getElementById("shipping").textContent = shipping + " ุฌ";

      const couponInput = document.getElementById("coupon");
      let discount = 0;
      if (couponInput && couponInput.value.trim().toUpperCase() === "TEFA4434") {
        discount = Math.round((subtotal + shipping) * 0.10);
      }
      document.getElementById("discount").textContent = discount + " ุฌ";

      const total = subtotal + shipping - discount;
      document.getElementById("total").textContent = total + " ุฌ";
      return { subtotal, shipping, discount, total };
    }

    document.getElementById("governorate").addEventListener("change", updateTotals);
    document.getElementById("coupon").addEventListener("input", updateTotals);

    // ุฅุฑุณุงู ุงูุทูุจ ูู Google Sheet
    document.getElementById("order-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = document.getElementById("form-message");
      msg.textContent = "";
      msg.className = "text-center text-sm mt-2";

      if (!cart.length) {
        msg.textContent = "ุงูุณูุฉ ูุงุถูุฉุ ุงุฎุชุงุฑู ููุชุฌ ุงูุฃูู.";
        msg.classList.add("text-red-500");
        return;
      }

      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const phone2 = document.getElementById("phone2").value.trim();
      const governorate = document.getElementById("governorate").value;
      const address = document.getElementById("address").value.trim();
      const notes = document.getElementById("notes").value.trim();
      const weight = document.getElementById("weight").value.trim();

      const totals = updateTotals();

      const productsText = cart.map(item => {
        const n = getItemName(item);
        const c = getItemColor(item);
        const q = getItemQty(item);
        const t = getItemTotal(item);
        return `${n}${c ? " - " + c : ""} ร${q} = ${t}ุฌ`;
      }).join("\n");

      const orderData = {
        name,
        phone,
        phone2,
        governorate,
        address,
        notes,
        weight,
        products: productsText,
        total: totals.total
      };

      msg.textContent = "ุฌุงุฑู ุฅุฑุณุงู ุงูุทูุจ...";
      msg.classList.remove("text-red-500", "text-green-500");
      msg.classList.add("text-gray-600");

      try {
        await fetch(SCRIPT_URL, {
          method: "POST",
          mode: "no-cors", // ูุชุฌุงูู CORS ููุด ูููุฑุฃ ุงูุงุณุชุฌุงุจุฉ
          body: JSON.stringify(orderData)
        });

        // ูู ูุตููุง ููุง ูุนุชุจุฑู ูุฌุงุญ
        msg.textContent = "ุชู ุชุณุฌูู ุงูุทูุจ ุจูุฌุงุญ โค๏ธ ุณูุชู ุงูุชูุงุตู ูุนู ูุชุฃููุฏ ุงูุดุญู.";
        msg.classList.remove("text-gray-600");
        msg.classList.add("text-green-600");

        cart = [];
        saveCart();
        loadCart();
      } catch (err) {
        console.error(err);
        msg.textContent = "ุญุตู ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุทูุจุ ุญุงููู ุชุงูู ุฃู ุชูุงุตูู ุนูู ูุงุชุณุงุจ.";
        msg.classList.remove("text-gray-600");
        msg.classList.add("text-red-500");
      }
    });

    // ุชุญููู ุงูุณูุฉ ุนูุฏ ูุชุญ ุงูุตูุญุฉ
    loadCart();
  </script>

</body>
</html>