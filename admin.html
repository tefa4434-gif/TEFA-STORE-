<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة تحكم TEFA STORE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 font-sans">

<!-- شاشة تسجيل الدخول -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center">
  <div class="bg-white rounded-3xl shadow p-6 w-full max-w-sm text-center">
    <h1 class="text-2xl font-extrabold mb-4">تسجيل دخول لوحة التحكم</h1>
    <input id="adminUser"
           type="text"
           placeholder="اسم المستخدم"
           class="w-full mb-3 p-2 border rounded-xl text-center">
    <input id="adminPass"
           type="password"
           placeholder="كلمة السر"
           class="w-full mb-3 p-2 border rounded-xl text-center">
    <button id="loginBtn"
            class="w-full bg-black text-white py-2 rounded-2xl font-bold">
      دخول
    </button>
    <p id="loginError" class="text-red-600 text-sm mt-2 hidden">
      بيانات الدخول غير صحيحة
    </p>
  </div>
</div>

<!-- لوحة التحكم الرئيسية -->
<div id="adminPanel" class="hidden min-h-screen">
  <!-- هيدر -->
  <header class="bg-black text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-extrabold">لوحة تحكم TEFA STORE</h1>
    <button id="logoutBtn"
            class="bg-red-600 text-white px-4 py-2 rounded-2xl text-sm">
      تسجيل خروج
    </button>
  </header>

  <main class="p-4 max-w-5xl mx-auto">

    <!-- إحصائيات -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-2xl shadow p-4 text-center">
        <p class="text-sm text-gray-500">إجمالي الطلبات</p>
        <p id="statTotalOrders" class="text-2xl font-extrabold">0</p>
      </div>
      <div class="bg-white rounded-2xl shadow p-4 text-center">
        <p class="text-sm text-gray-500">طلبات اليوم</p>
        <p id="statTodayOrders" class="text-2xl font-extrabold">0</p>
      </div>
      <div class="bg-white rounded-2xl shadow p-4 text-center">
        <p class="text-sm text-gray-500">آخر محافظة في الطلبات</p>
        <p id="statLastGov" class="text-lg font-bold">-</p>
      </div>
      <div class="bg-white rounded-2xl shadow p-4 text-center">
        <p class="text-sm text-gray-500">عدد زوار الموقع (هذا المتصفح)</p>
        <p id="statViews" class="text-2xl font-extrabold">0</p>
      </div>
    </section>

    <!-- إدارة الموديلات و إيقاف الألوان -->
    <section class="bg-white rounded-2xl shadow p-4 mb-6">
      <h2 class="text-xl font-extrabold mb-2">إدارة الموديلات و إيقاف الألوان</h2>
      <p class="text-xs text-gray-500 mb-3">
        لو عايز توقف لون معين، شيل علامة ✓ من أمامه. اللون الموقوف هيظهر عند العميل باهت و مش هيقدر يطلبه.
      </p>
      <div id="modelsManagement" class="space-y-4"></div>
    </section>

    <!-- قائمة الطلبات -->
    <section class="bg-white rounded-2xl shadow p-4 mb-6">
      <h2 class="text-xl font-extrabold mb-2">قائمة الطلبات</h2>
      <p class="text-xs text-gray-500 mb-3">
        الطلبات محفوظة في LocalStorage لهذا المتصفح.
      </p>

      <!-- بحث و فلاتر -->
      <div class="flex flex-col md:flex-row gap-2 mb-3">
        <input id="searchInput"
               type="text"
               placeholder="بحث بالاسم أو التليفون..."
               class="flex-1 border rounded-xl p-2 text-sm">
        <select id="filterGov"
                class="border rounded-xl p-2 text-sm">
          <option value="">كل المحافظات</option>
        </select>
        <select id="filterDate"
                class="border rounded-xl p-2 text-sm">
          <option value="all">كل الأوقات</option>
          <option value="today">اليوم فقط</option>
        </select>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm text-center border">
          <thead class="bg-gray-100">
          <tr>
            <th class="border p-2">#</th>
            <th class="border p-2">العميل</th>
            <th class="border p-2">التليفون</th>
            <th class="border p-2">المحافظة</th>
            <th class="border p-2">الإجمالي</th>
            <th class="border p-2">المنتجات</th>
            <th class="border p-2">الوقت</th>
          </tr>
          </thead>
          <tbody id="ordersTableBody">
          <!-- الصفوف تتولد بالسكربت -->
          </tbody>
        </table>
      </div>

      <p id="ordersSummary" class="text-xs text-gray-600 mt-2">
        لا توجد طلبات مسجلة.
      </p>
    </section>

  </main>
</div>

<script>
// ===================== تسجيل الدخول =====================
const ADMIN_USERNAME = "tefa";
const ADMIN_PASSWORD = "4434";

const loginScreen = document.getElementById("loginScreen");
const adminPanel  = document.getElementById("adminPanel");
const loginBtn    = document.getElementById("loginBtn");
const logoutBtn   = document.getElementById("logoutBtn");
const loginError  = document.getElementById("loginError");

function showPanel() {
  loginScreen.classList.add("hidden");
  adminPanel.classList.remove("hidden");
  initDashboard();
}
function showLogin() {
  adminPanel.classList.add("hidden");
  loginScreen.classList.remove("hidden");
}

(function checkLogin() {
  const logged = localStorage.getItem("admin_logged_in") === "1";
  if (logged) showPanel();
})();

loginBtn.addEventListener("click", () => {
  const user = document.getElementById("adminUser").value.trim().toLowerCase();
  const pass = document.getElementById("adminPass").value.trim();
  if (user === ADMIN_USERNAME && pass === ADMIN_PASSWORD) {
    localStorage.setItem("admin_logged_in", "1");
    loginError.classList.add("hidden");
    showPanel();
  } else {
    loginError.classList.remove("hidden");
  }
});

logoutBtn.addEventListener("click", () => {
  localStorage.removeItem("admin_logged_in");
  location.reload();
});

// ===================== بيانات المنتجات و الألوان =====================
const PRODUCT_MODELS = {
  rozalin: {
    name: "طقم روزالين 3 قطع",
    colors: [
      { label: "كافيه", hex: "#8b6a4f" },
      { label: "بيج",   hex: "#ead7b7" },
      { label: "موف",   hex: "#7c3aed" },
      { label: "زيتي",  hex: "#4b7351" },
      { label: "أسود",  hex: "#000000" },
      { label: "سيمون", hex: "#f4a6a6" }
    ]
  },
  formal: {
    name: "طقم فورمال 3 قطع",
    colors: [
      { label: "منت",      hex: "#98ff98" },
      { label: "بيبي بلو", hex: "#a7c7ff" },
      { label: "بيج",      hex: "#ead7b7" },
      { label: "هافان",    hex: "#8b5a2b" },
      { label: "أسود",     hex: "#000000" }
    ]
  },
  toonz: {
    name: "تونز – قطعتين",
    colors: [
      { label: "أزرق",  hex: "#1e3a8a" },
      { label: "بينك",  hex: "#ec4899" },
      { label: "بيج",   hex: "#ead7b7" },
      { label: "زيتي",  hex: "#6b8f71" },
      { label: "نبيتي", hex: "#6d1b1b" },
      { label: "موف",   hex: "#7c3aed" }
    ]
  },
  abaya_btn: {
    name: "عباية زراير كبس",
    colors: [
      { label: "كراميل",     hex: "#c19a6b" },
      { label: "نبيتي",      hex: "#6b1b1b" },
      { label: "رمادي فاتح", hex: "#d1d5db" },
      { label: "زيتي",       hex: "#6b8f71" },
      { label: "أسود",       hex: "#000000" },
      { label: "رمادي غامق", hex: "#374151" }
    ]
  }
};

// disabledColors[productId][colorLabel] = true  => اللون موقوف
function loadDisabledColors() {
  try {
    return JSON.parse(localStorage.getItem("disabledColors") || "{}");
  } catch (e) {
    return {};
  }
}
function saveDisabledColors(map) {
  localStorage.setItem("disabledColors", JSON.stringify(map));
}

// ===================== الطلبات =====================
function loadOrders() {
  try {
    return JSON.parse(localStorage.getItem("orders") || "[]");
  } catch (e) {
    return [];
  }
}

// ===================== تهيئة لوحة التحكم =====================
function initDashboard() {
  renderStats();
  renderModelsManagement();
  renderOrdersTable();
}

// --------- الإحصائيات ---------
function renderStats() {
  const orders = loadOrders();
  const totalOrders = orders.length;

  const today = new Date();
  today.setHours(0,0,0,0);

  let todayCount = 0;
  let lastGov = "-";

  orders.forEach(o => {
    if (o.createdAt) {
      const d = new Date(o.createdAt);
      if (!isNaN(d) && d >= today) todayCount++;
    }
    if (o.governorate) lastGov = o.governorate;
  });

  const views = parseInt(localStorage.getItem("store_total_views") || "0", 10) || 0;

  document.getElementById("statTotalOrders").textContent = totalOrders;
  document.getElementById("statTodayOrders").textContent = todayCount;
  document.getElementById("statLastGov").textContent   = lastGov || "-";
  document.getElementById("statViews").textContent      = views;
}

// --------- إدارة الموديلات / الألوان ---------
function renderModelsManagement() {
  const container = document.getElementById("modelsManagement");
  container.innerHTML = "";
  const disabledMap = loadDisabledColors();

  Object.keys(PRODUCT_MODELS).forEach(pid => {
    const model = PRODUCT_MODELS[pid];
    const card = document.createElement("div");
    card.className = "border rounded-2xl p-3";

    const title = document.createElement("h3");
    title.className = "font-bold mb-2";
    title.textContent = model.name;
    card.appendChild(title);

    const colorsWrap = document.createElement("div");
    colorsWrap.className = "flex flex-wrap gap-3";

    model.colors.forEach(col => {
      const wrapper = document.createElement("label");
      wrapper.className = "flex items-center gap-1 text-sm";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      const isDisabled = !!(disabledMap[pid] && disabledMap[pid][col.label]);
      checkbox.checked = !isDisabled;

      checkbox.addEventListener("change", () => {
        const map = loadDisabledColors();
        if (!map[pid]) map[pid] = {};
        map[pid][col.label] = !checkbox.checked; // لو متعلم صح => نشط
        saveDisabledColors(map);
      });

      const dot = document.createElement("span");
      dot.className = "w-4 h-4 rounded-full border";
      if (col.hex) dot.style.backgroundColor = col.hex;

      const text = document.createElement("span");
      text.textContent = col.label;

      wrapper.appendChild(checkbox);
      wrapper.appendChild(dot);
      wrapper.appendChild(text);
      colorsWrap.appendChild(wrapper);
    });

    card.appendChild(colorsWrap);
    container.appendChild(card);
  });
}

// --------- جدول الطلبات ---------
function renderOrdersTable() {
  const orders       = loadOrders();
  const tbody        = document.getElementById("ordersTableBody");
  const summaryEl    = document.getElementById("ordersSummary");
  const filterGovSel = document.getElementById("filterGov");

  tbody.innerHTML = "";

  // تعبئة قائمة المحافظات في الفلتر
  const govSet = new Set();
  orders.forEach(o => { if (o.governorate) govSet.add(o.governorate); });
  filterGovSel.innerHTML = '<option value="">كل المحافظات</option>';
  [...govSet].forEach(g => {
    const op = document.createElement("option");
    op.value = g;
    op.textContent = g;
    filterGovSel.appendChild(op);
  });

  function applyFilters() {
    const search = document.getElementById("searchInput").value.trim().toLowerCase();
    const gov    = filterGovSel.value;
    const dateF  = document.getElementById("filterDate").value;

    const today = new Date();
    today.setHours(0,0,0,0);

    let filtered = orders.slice();

    if (search) {
      filtered = filtered.filter(o =>
        (o.name && o.name.toLowerCase().includes(search)) ||
        (o.phone && String(o.phone).includes(search))
      );
    }

    if (gov) {
      filtered = filtered.filter(o => o.governorate === gov);
    }

    if (dateF === "today") {
      filtered = filtered.filter(o => {
        if (!o.createdAt) return false;
        const d = new Date(o.createdAt);
        if (isNaN(d)) return false;
        d.setHours(0,0,0,0);
        return d.getTime() === today.getTime();
      });
    }

    tbody.innerHTML = "";
    filtered.forEach((o, idx) => {
      const tr = document.createElement("tr");

      const productsText = (o.items || o.products || [])
        .map(it => `${it.name || it.productName || ""} (${it.color || ""} × ${it.qty || 1})`)
        .join("، ");

      const total = o.total || o.totalPrice || 0;

      const created = o.createdAt ? new Date(o.createdAt) : null;
      const timeStr = created && !isNaN(created)
        ? created.toLocaleString("ar-EG")
        : "-";

      tr.innerHTML = `
        <td class="border p-2">${idx + 1}</td>
        <td class="border p-2">${o.name || "-"}</td>
        <td class="border p-2">${o.phone || "-"}</td>
        <td class="border p-2">${o.governorate || "-"}</td>
        <td class="border p-2">${total} ج</td>
        <td class="border p-2 text-xs">${productsText || "-"}</td>
        <td class="border p-2 text-xs">${timeStr}</td>
      `;
      tbody.appendChild(tr);
    });

    if (!filtered.length) {
      summaryEl.textContent = "لا توجد طلبات مطابقة للفلاتر الحالية.";
    } else {
      summaryEl.textContent = `إجمالي الطلبات المعروضة: ${filtered.length}`;
    }
  }

  // أول رسم
  applyFilters();

  // أحداث الفلتر والبحث
  document.getElementById("searchInput").addEventListener("input", applyFilters);
  filterGovSel.addEventListener("change", applyFilters);
  document.getElementById("filterDate").addEventListener("change", applyFilters);
}
</script>

</body>
</html>